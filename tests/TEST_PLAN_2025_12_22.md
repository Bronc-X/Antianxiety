# End-to-End Test Plan: Assessment System (2025-12-22)

**Version:** 1.0  
**Target:** Validation of "Acquisition â†’ Storage â†’ Assessment â†’ Trigger â†’ Refresh â†’ Chat Context" loop.  
**Audience:** Internal QA / Beta Testing Team

---

## ðŸ›  Pre-requisites & Environment

1.  **Environment**: Staging/Dev Supabase.
2.  **Test Accounts**: Prepare 4 users:
    *   `U1` (Low Risk): GAD2=0-1, Sleep 7-8h, Low Stress.
    *   `U2` (Medium Risk): GAD2=2-3, Sleep 6-7h, Medium Stress.
    *   `U3` (High Risk): GAD2â‰¥3 or Sleep < 5h continuously.
    *   `U4` (Safety Trigger): PHQ-9 Q9 = 1 (Self-harm ideation).
3.  **RPC Check**: Ensure `merge_inferred_scores` function exists in DB.
4.  **Guardrails**: `active-inquiry-guardrails.ts` active with cooldowns.

---

## ðŸ§ª Test Cases Checklist

### A. Onboarding (Registration Scales)

#### [ ] A1: Baseline Completion
- **Step**: Log into `U1` â†’ Start Onboarding â†’ Complete 23 questions â†’ Submit.
- **Expected**: 
    - Redirect to Upgrade/Dashboard.
    - DB: `user_scale_responses` has 23 records.
    - DB: `profiles.inferred_scale_scores` contains 'GAD7', 'PHQ9', 'ISI'.
- **Logs/Validation**:
    - API: `/api/user/refresh` returns 200.
    - SQL: `select count(*) from user_scale_responses where user_id = 'U1';` (Should be >= 23)

#### [ ] A2: Safety Branch
- **Step**: Log into `U4` â†’ In PHQ-9, set Q9 = "Several days" (1) or higher.
- **Expected**:
    - Immediate "Compassionate Care" modal/alert appears.
    - User can proceed after acknowledgement.
    - DB: `safety_events` has new record.
- **Logs/Validation**:
    - SQL: `select * from safety_events where user_id = 'U4' order by created_at desc;`

#### [ ] A3: Pause & Resume
- **Step**: Reach Page 2 â†’ Click "Save/Pause" or Navigate away â†’ Return to Onboarding.
- **Expected**: Resumes from Page 2 (or last saved state).
- **Logs/Validation**: Check `localStorage` for `onboarding_progress_<uid>`.

---

### B. Daily Calibration

#### [ ] B1: Fixed Question Set
- **Step**: `U1` starts Daily Check-in â†’ Answer 5 questions.
- **Expected**:
    - Questions: GAD-2 (2), Sleep Duration (1), Sleep Quality (1), Stress (1).
    - Result page shows "Daily Index".
- **Logs/Validation**:
    - DB: `user_scale_responses` count +5 for today. `scale_id` = 'DAILY'.

#### [ ] B2: Full Scale Trigger
- **Step**: `U3` answers GAD-2 questions with score â‰¥ 3.
- **Expected**:
    - Result page suggests "Full GAD-7 Assessment".
    - DB: `scale_trigger_logs` records trigger event.
- **Logs/Validation**:
    - SQL: `select * from scale_trigger_logs where user_id = 'U3';`

#### [ ] B3: Red Flag Logic
- **Step**: Answer Sleep < 5h OR Stress = High (Max).
- **Expected**:
    - Result page: "Status requires attention" (Red Flag Alert).
    - Frequency: Does NOT automatically drop to "Every Other Day" (stability broken).
- **Logs/Validation**:
    - API Response: `stability.hasRedFlag` = true.

#### [ ] B4: Frequency Adaptation (Mock Data)
- **Step**: Use SQL to insert 7 days of stable low-risk data for `U1`. Open App next day.
- **Expected**:
    - Home/Check-in shows "Suggested Frequency: Every Other Day" or "Rest Day".
    - "I want to calibrate" button available to override.
- **Logs/Validation**:
    - DB: `user_assessment_preferences.daily_frequency` changes.

#### [ ] B5: Wellness Log Sync
- **Step**: Complete Daily Calibration.
- **Expected**: `daily_wellness_logs` updated with sleep hours and stress level.
- **Logs/Validation**:
    - SQL: `select * from daily_wellness_logs where user_id = 'U1' and log_date = current_date;`

---

### C. Weekly Calibration

#### [ ] C1: End-to-End Flow
- **Step**: `U2` completes Weekly Check-in (PSS-4 + Evolution Question).
- **Expected**: 
    - `user_scale_responses` +5 records.
    - `profiles.last_weekly_calibration` updated.
- **Logs/Validation**:
    - SQL: `select last_weekly_calibration from profiles where id = 'U2';`

#### [ ] C2: Evolution Question Semantics
- **Step**: In Evolution Question (Text/Choice), select "Work Pressure".
- **Expected**: Saved value is readable text/code (e.g., 'work').
- **Logs/Validation**: `answer_text` column in `user_scale_responses`.

---

### D. Monthly Calibration

#### [ ] D1: Completion & storage
- **Step**: `U1` completes Monthly (PSS-10 / GAD-7 / PHQ-9).
- **Expected**:
    - `user_scale_responses` populated.
    - `profiles.last_monthly_calibration` updated.

#### [ ] D2: Score Merging
- **Step**: Complete PSS-10. Then later complete GAD-7.
- **Expected**: `profiles.inferred_scale_scores` contains BOTH PSS-10 and GAD-7 scores (merge, not overwrite).
- **Logs/Validation**:
    - SQL: `select inferred_scale_scores from profiles where id = 'U1';`

---

### E. Active Inquiry & AI Loop

#### [ ] E1: Template Replacement
- **Step**: Trigger `plan_item_followup` (via Chat or DevTools).
- **Expected**: Question text has no `{}` placeholders (correctly filled).
- **Logs/Validation**: `ai_memory` records template ID + category.

#### [ ] E2: Cooldown Enforcement
- **Step**: Trigger same template again within 24h.
- **Expected**: Request blocked/skipped.
- **Logs/Validation**: `generateGuardedInquiry` returns reason "CoolDown".

#### [ ] E3: Forbidden Topics
- **Step**: Try to force AI to ask about "Medical Diagnosis" or "Dosage".
- **Expected**: Generation refused/filtered.
- **Logs/Validation**: `containsForbiddenTopic` = true.

#### [ ] F1: Closed Loop Refresh
- **Step**: Complete any calibration â†’ Check logs.
- **Expected**: `/api/user/refresh` called. `profiles.ai_analysis_result` updated.
- **Logs/Validation**: Check network tab for `refresh` call.

#### [ ] F2: Chat Context Awareness
- **Step**: Complete Daily Calibration (e.g., High Stress). Immediately start Chat.
- **Expected**: AI mentions "I see your stress is high today" or similar context.
- **Logs/Validation**: Server logs for `buildUserContext`.

---

### G. Internationalization (i18n)

#### [ ] G1: English Locale
- **Step**: Switch App Language to EN.
- **Expected**: All questions, hints, and results are in English.
- **Evidence**: Screenshots.

---

## ðŸ” Validation SQL Scripts

See \`tests/manual_verification.sql\` for ready-to-use queries.
