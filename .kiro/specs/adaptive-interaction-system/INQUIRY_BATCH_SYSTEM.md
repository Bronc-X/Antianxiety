# Inquiry Batch System - æ‰¹é‡è¯¢é—®ç³»ç»Ÿ

## æ–°çš„ç”¨æˆ·ä½“éªŒç­–ç•¥

### æ ¸å¿ƒé€»è¾‘
1. **ä¸€æ¬¡æ˜¾ç¤º2ä¸ªé—®é¢˜** - ç”¨æˆ·è¿ç»­å›ç­”ï¼Œæ— éœ€åˆ·æ–°
2. **20åˆ†é’Ÿå†·å´æœŸ** - å›ç­”å®Œ2ä¸ªé—®é¢˜åï¼Œ20åˆ†é’Ÿå†…ä¸ä¼šå†é—®
3. **æµç•…ä½“éªŒ** - é—®é¢˜ä¹‹é—´è‡ªåŠ¨åˆ‡æ¢ï¼Œæ— éœ€æ‰‹åŠ¨æ“ä½œ

### ç”¨æˆ·æµç¨‹

```
ç”¨æˆ·æ‰“å¼€App
    â†“
æ˜¾ç¤ºç¬¬1ä¸ªé—®é¢˜
    â†“
ç”¨æˆ·é€‰æ‹©ç­”æ¡ˆ â†’ ç‚¹å‡»æäº¤
    â†“
è‡ªåŠ¨æ˜¾ç¤ºç¬¬2ä¸ªé—®é¢˜ (æ— éœ€åˆ·æ–°)
    â†“
ç”¨æˆ·é€‰æ‹©ç­”æ¡ˆ â†’ ç‚¹å‡»æäº¤
    â†“
æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯ (2ç§’)
    â†“
Banneræ¶ˆå¤±
    â†“
ã€20åˆ†é’Ÿå†·å´æœŸã€‘
    â†“
20åˆ†é’Ÿåå¯ä»¥å†æ¬¡æ˜¾ç¤º2ä¸ªæ–°é—®é¢˜
```

## æŠ€æœ¯å®ç°

### å‰ç«¯ç»„ä»¶ (ActiveInquiryBanner.tsx)

**çŠ¶æ€ç®¡ç†ï¼š**
```typescript
const [inquiries, setInquiries] = useState<InquiryQuestion[]>([]);  // å­˜å‚¨2ä¸ªé—®é¢˜
const [currentIndex, setCurrentIndex] = useState(0);                // å½“å‰é—®é¢˜ç´¢å¼•
const [responses, setResponses] = useState<Array<...>>([]);         // å­˜å‚¨æ‰€æœ‰å›ç­”
```

**åŠ è½½é€»è¾‘ï¼š**
- ç»„ä»¶æŒ‚è½½æ—¶ï¼Œè¿ç»­è°ƒç”¨2æ¬¡ `/api/inquiry/pending`
- è·å–2ä¸ªä¸åŒçš„é—®é¢˜å­˜å…¥ `inquiries` æ•°ç»„
- å¦‚æœåªè·å–åˆ°1ä¸ªé—®é¢˜ï¼Œä¹Ÿå¯ä»¥æ­£å¸¸å·¥ä½œ

**æäº¤é€»è¾‘ï¼š**
```typescript
handleSubmitResponse() {
  // æäº¤å½“å‰é—®é¢˜çš„ç­”æ¡ˆ
  await fetch('/api/inquiry/respond', ...)
  
  if (!isLastQuestion) {
    // è¿˜æœ‰ä¸‹ä¸€ä¸ªé—®é¢˜ â†’ åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ª
    setCurrentIndex(currentIndex + 1)
    setSelectedOption(null)  // æ¸…ç©ºé€‰æ‹©
  } else {
    // æœ€åä¸€ä¸ªé—®é¢˜ â†’ æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
    setShowSuccess(true)
    setTimeout(() => handleDismiss(), 2000)
  }
}
```

**è¿›åº¦æ˜¾ç¤ºï¼š**
- Headeræ˜¾ç¤º "1/2" æˆ– "2/2" è¿›åº¦
- ç”¨æˆ·æ¸…æ¥šçŸ¥é“è¿˜æœ‰å‡ ä¸ªé—®é¢˜

### åç«¯API (inquiry/pending/route.ts)

**å†·å´æœŸæ£€æŸ¥ï¼š**
```typescript
const twentyMinutesAgo = new Date();
twentyMinutesAgo.setMinutes(twentyMinutesAgo.getMinutes() - 20);

const { data: recentResponse } = await supabase
  .from('inquiry_history')
  .select('responded_at')
  .eq('user_id', user.id)
  .not('user_response', 'is', null)
  .gte('responded_at', twentyMinutesAgo.toISOString())
  .order('responded_at', { ascending: false })
  .limit(1)
  .single();

if (recentResponse) {
  // è¿˜åœ¨å†·å´æœŸå†…ï¼Œä¸è¿”å›æ–°é—®é¢˜
  return NextResponse.json({ hasInquiry: false });
}
```

**æ•°æ®å»é‡ï¼š**
- æ£€æŸ¥ä»Šå¤©å·²ç»å›ç­”è¿‡çš„ data_gaps
- è¿‡æ»¤æ‰å·²å›ç­”çš„gapï¼Œé¿å…é‡å¤è¯¢é—®

## ç”¨æˆ·ä½“éªŒä¼˜åŠ¿

### âœ… ä¼˜ç‚¹
1. **é«˜æ•ˆ** - ä¸€æ¬¡æ€§å›ç­”2ä¸ªé—®é¢˜ï¼Œä¸éœ€è¦å¤šæ¬¡åˆ·æ–°
2. **æµç•…** - é—®é¢˜ä¹‹é—´è‡ªåŠ¨åˆ‡æ¢ï¼Œä½“éªŒè¿è´¯
3. **ä¸æ‰“æ‰°** - 20åˆ†é’Ÿå†·å´æœŸï¼Œä¸ä¼šé¢‘ç¹éªšæ‰°ç”¨æˆ·
4. **æ¸…æ™°** - è¿›åº¦æ˜¾ç¤ºè®©ç”¨æˆ·çŸ¥é“è¿˜æœ‰å‡ ä¸ªé—®é¢˜
5. **çµæ´»** - å¦‚æœåªæœ‰1ä¸ªé—®é¢˜ï¼Œä¹Ÿèƒ½æ­£å¸¸å·¥ä½œ

### ğŸ“Š æ•°æ®æ”¶é›†æ•ˆç‡
- æ¯æ¬¡äº¤äº’æ”¶é›†2ä¸ªæ•°æ®ç‚¹
- 20åˆ†é’Ÿå†·å´æœŸ = æ¯å°æ—¶æœ€å¤š3æ¬¡ = æ¯å°æ—¶æœ€å¤š6ä¸ªæ•°æ®ç‚¹
- æ¯å¤©æ´»è·ƒç”¨æˆ·å¯ä»¥æ”¶é›† 20-30 ä¸ªæ•°æ®ç‚¹

## é…ç½®å‚æ•°

### å¯è°ƒæ•´çš„å‚æ•°

**å‰ç«¯ (ActiveInquiryBanner.tsx):**
```typescript
// ç¬¬40è¡Œï¼šæ¯æ¬¡åŠ è½½çš„é—®é¢˜æ•°é‡
for (let i = 0; i < 2; i++) {  // æ”¹æˆ 3 å¯ä»¥ä¸€æ¬¡é—®3ä¸ªé—®é¢˜
  ...
}
```

**åç«¯ (inquiry/pending/route.ts):**
```typescript
// ç¬¬28è¡Œï¼šå†·å´æ—¶é—´
twentyMinutesAgo.setMinutes(twentyMinutesAgo.getMinutes() - 20);
// æ”¹æˆ -30 = 30åˆ†é’Ÿå†·å´
// æ”¹æˆ -10 = 10åˆ†é’Ÿå†·å´
```

## æµ‹è¯•æ­¥éª¤

1. **é¦–æ¬¡åŠ è½½**
   - æ‰“å¼€App â†’ çœ‹åˆ°ç¬¬1ä¸ªé—®é¢˜ (æ˜¾ç¤º "1/2")
   - é€‰æ‹©ç­”æ¡ˆ â†’ ç‚¹å‡»æäº¤
   - è‡ªåŠ¨æ˜¾ç¤ºç¬¬2ä¸ªé—®é¢˜ (æ˜¾ç¤º "2/2")
   - é€‰æ‹©ç­”æ¡ˆ â†’ ç‚¹å‡»æäº¤
   - çœ‹åˆ°æˆåŠŸæ¶ˆæ¯ â†’ Banneræ¶ˆå¤±

2. **å†·å´æœŸæµ‹è¯•**
   - ç«‹å³åˆ·æ–°é¡µé¢ â†’ ä¸åº”è¯¥çœ‹åˆ°æ–°é—®é¢˜
   - ç­‰å¾…20åˆ†é’Ÿ â†’ åˆ·æ–°é¡µé¢ â†’ åº”è¯¥çœ‹åˆ°æ–°çš„2ä¸ªé—®é¢˜

3. **æ§åˆ¶å°æ—¥å¿—**
   ```
   ğŸ“‹ [Inquiry] Loaded question 1: æ˜¨æ™šç¡å¾—æ€ä¹ˆæ ·ï¼Ÿ
   ğŸ“‹ [Inquiry] Loaded question 2: ä»Šå¤©æ„Ÿè§‰å‹åŠ›å¤§å—ï¼Ÿ
   âœ… [Inquiry] Response submitted: æ„Ÿè°¢ä½ çš„å›ç­”ï¼
   âœ… [Inquiry] Response submitted: æ„Ÿè°¢ä½ çš„å›ç­”ï¼
   ```

4. **å†·å´æœŸæ—¥å¿—**
   ```
   ğŸ“‹ [Inquiry] Cooldown active (5/20 minutes)
   ```

## æœªæ¥ä¼˜åŒ–

1. **æ™ºèƒ½æ’åº** - æ ¹æ®ä¼˜å…ˆçº§æ’åºé—®é¢˜ï¼ˆhigh â†’ medium â†’ lowï¼‰
2. **åŠ¨æ€æ•°é‡** - æ ¹æ®ç”¨æˆ·æ´»è·ƒåº¦è°ƒæ•´é—®é¢˜æ•°é‡ï¼ˆæ´»è·ƒç”¨æˆ·å¯ä»¥é—®3ä¸ªï¼‰
3. **æ—¶é—´ä¼˜åŒ–** - æ ¹æ®ç”¨æˆ·æ´»åŠ¨æ¨¡å¼é€‰æ‹©æœ€ä½³è¯¢é—®æ—¶é—´
4. **è¿›åº¦ä¿å­˜** - å¦‚æœç”¨æˆ·ä¸­é€”é€€å‡ºï¼Œä¸‹æ¬¡ç»§ç»­æœªå®Œæˆçš„é—®é¢˜
5. **A/Bæµ‹è¯•** - æµ‹è¯•ä¸åŒçš„å†·å´æ—¶é—´å’Œé—®é¢˜æ•°é‡

## ç›¸å…³æ–‡ä»¶

- `Antianxiety-main/components/ActiveInquiryBanner.tsx` - å‰ç«¯ç»„ä»¶
- `Antianxiety-main/app/api/inquiry/pending/route.ts` - è·å–é—®é¢˜API
- `Antianxiety-main/app/api/inquiry/respond/route.ts` - æäº¤ç­”æ¡ˆAPI
- `Antianxiety-main/lib/inquiry-engine.ts` - é—®é¢˜ç”Ÿæˆå¼•æ“
