<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¡åˆ’æ•°æ®è°ƒè¯•</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
        }
        h1 {
            color: #4ec9b0;
        }
        button {
            padding: 10px 20px;
            background: #0e639c;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 5px;
            font-size: 14px;
        }
        button:hover {
            background: #1177bb;
        }
        .section {
            background: #252526;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid #4ec9b0;
            border-radius: 4px;
        }
        pre {
            background: #1e1e1e;
            padding: 15px;
            overflow-x: auto;
            border-radius: 4px;
            border: 1px solid #3c3c3c;
        }
        .success {
            color: #4ec9b0;
        }
        .error {
            color: #f48771;
        }
        .warning {
            color: #dcdcaa;
        }
    </style>
</head>
<body>
    <h1>ğŸ” è®¡åˆ’æ•°æ®è°ƒè¯•å·¥å…·</h1>
    
    <div class="section">
        <h2>å¿«é€Ÿæµ‹è¯•</h2>
        <button onclick="testAll()">è¿è¡Œå…¨éƒ¨æµ‹è¯•</button>
        <button onclick="location.reload()">åˆ·æ–°é¡µé¢</button>
    </div>

    <div class="section">
        <h2>1. æµ‹è¯• API /api/plans/list</h2>
        <button onclick="testListAPI()">æµ‹è¯•è·å–è®¡åˆ’åˆ—è¡¨</button>
        <pre id="list-result"></pre>
    </div>

    <div class="section">
        <h2>2. æµ‹è¯•æ•°æ®åº“æŸ¥è¯¢ï¼ˆé€šè¿‡APIï¼‰</h2>
        <button onclick="testDatabaseQuery()">æŸ¥è¯¢æ•°æ®åº“</button>
        <pre id="db-result"></pre>
    </div>

    <div class="section">
        <h2>3. æ£€æŸ¥æ•°æ®æ ¼å¼</h2>
        <button onclick="checkDataFormat()">æ£€æŸ¥æ ¼å¼</button>
        <pre id="format-result"></pre>
    </div>

    <script>
        function log(elementId, message, type = 'info') {
            const el = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'success' ? 'success' : type === 'error' ? 'error' : 'warning';
            el.innerHTML += `<span class="${color}">[${timestamp}] ${message}</span>\n`;
        }

        async function testListAPI() {
            const el = document.getElementById('list-result');
            el.innerHTML = '';
            
            try {
                log('list-result', 'ğŸ“¤ å‘èµ·è¯·æ±‚: GET /api/plans/list?status=active&limit=20');
                
                const response = await fetch('/api/plans/list?status=active&limit=20');
                log('list-result', `ğŸ“Š HTTP çŠ¶æ€ç : ${response.status}`, response.ok ? 'success' : 'error');
                
                const data = await response.json();
                log('list-result', 'ğŸ“¦ å“åº”æ•°æ®:', 'info');
                log('list-result', JSON.stringify(data, null, 2), 'info');
                
                if (data.success) {
                    const plans = data.data?.plans || [];
                    log('list-result', `âœ… æˆåŠŸè·å– ${plans.length} ä¸ªè®¡åˆ’`, 'success');
                    
                    if (plans.length === 0) {
                        log('list-result', 'âš ï¸ è­¦å‘Šï¼šè®¡åˆ’åˆ—è¡¨ä¸ºç©ºï¼', 'warning');
                        log('list-result', 'å¯èƒ½åŸå› ï¼š', 'warning');
                        log('list-result', '1. ç”¨æˆ·æ²¡æœ‰ä¿å­˜ä»»ä½•è®¡åˆ’', 'warning');
                        log('list-result', '2. æ•°æ®ä¿å­˜å¤±è´¥', 'warning');
                        log('list-result', '3. RLSç­–ç•¥é˜»æ­¢äº†æŸ¥è¯¢', 'warning');
                    } else {
                        plans.forEach((plan, index) => {
                            log('list-result', `\nè®¡åˆ’ ${index + 1}:`, 'success');
                            log('list-result', `  ID: ${plan.id}`, 'info');
                            log('list-result', `  æ ‡é¢˜: ${plan.title}`, 'info');
                            log('list-result', `  ç±»å‹: ${plan.plan_type}`, 'info');
                            log('list-result', `  éš¾åº¦: ${plan.difficulty}`, 'info');
                            log('list-result', `  çŠ¶æ€: ${plan.status}`, 'info');
                            log('list-result', `  åˆ›å»ºæ—¶é—´: ${plan.created_at}`, 'info');
                        });
                    }
                } else {
                    log('list-result', `âŒ APIè¿”å›å¤±è´¥: ${data.error}`, 'error');
                }
                
            } catch (error) {
                log('list-result', `âŒ è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
                log('list-result', `å †æ ˆ: ${error.stack}`, 'error');
            }
        }

        async function testDatabaseQuery() {
            const el = document.getElementById('db-result');
            el.innerHTML = '';
            
            try {
                log('db-result', 'ğŸ“¤ ç›´æ¥æŸ¥è¯¢æ•°æ®åº“ï¼ˆé€šè¿‡ list APIï¼‰');
                
                const response = await fetch('/api/plans/list?status=active&limit=100');
                const data = await response.json();
                
                if (data.success && data.data?.plans) {
                    const plans = data.data.plans;
                    log('db-result', `âœ… æ•°æ®åº“ä¸­å…±æœ‰ ${plans.length} ä¸ªæ´»è·ƒè®¡åˆ’`, 'success');
                    log('db-result', `\nå®Œæ•´æ•°æ®:`, 'info');
                    log('db-result', JSON.stringify(plans, null, 2), 'info');
                } else {
                    log('db-result', 'âŒ æ— æ³•ä»æ•°æ®åº“è·å–æ•°æ®', 'error');
                    log('db-result', JSON.stringify(data, null, 2), 'error');
                }
                
            } catch (error) {
                log('db-result', `âŒ æŸ¥è¯¢å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function checkDataFormat() {
            const el = document.getElementById('format-result');
            el.innerHTML = '';
            
            try {
                log('format-result', 'ğŸ” æ£€æŸ¥æ•°æ®æ ¼å¼è§„èŒƒ');
                
                const response = await fetch('/api/plans/list?status=active&limit=20');
                const data = await response.json();
                
                log('format-result', 'æ£€æŸ¥é¡¶å±‚ç»“æ„:', 'info');
                log('format-result', `  success: ${data.success ? 'âœ…' : 'âŒ'}`, data.success ? 'success' : 'error');
                log('format-result', `  data å¯¹è±¡å­˜åœ¨: ${data.data ? 'âœ…' : 'âŒ'}`, data.data ? 'success' : 'error');
                
                if (data.data) {
                    log('format-result', '\næ£€æŸ¥ data å¯¹è±¡:', 'info');
                    log('format-result', `  plans æ•°ç»„å­˜åœ¨: ${data.data.plans ? 'âœ…' : 'âŒ'}`, data.data.plans ? 'success' : 'error');
                    log('format-result', `  plans ç±»å‹: ${Array.isArray(data.data.plans) ? 'Array âœ…' : 'NOT Array âŒ'}`, Array.isArray(data.data.plans) ? 'success' : 'error');
                    log('format-result', `  plans é•¿åº¦: ${data.data.plans?.length || 0}`, 'info');
                    
                    if (data.data.plans && data.data.plans.length > 0) {
                        const plan = data.data.plans[0];
                        log('format-result', '\næ£€æŸ¥ç¬¬ä¸€ä¸ªè®¡åˆ’çš„å­—æ®µ:', 'info');
                        const requiredFields = ['id', 'title', 'plan_type', 'difficulty', 'status', 'created_at'];
                        requiredFields.forEach(field => {
                            const exists = field in plan;
                            log('format-result', `  ${field}: ${exists ? 'âœ…' : 'âŒ ç¼ºå¤±'}`, exists ? 'success' : 'error');
                        });
                        
                        log('format-result', '\nå®Œæ•´çš„ç¬¬ä¸€ä¸ªè®¡åˆ’:', 'info');
                        log('format-result', JSON.stringify(plan, null, 2), 'info');
                    }
                }
                
            } catch (error) {
                log('format-result', `âŒ æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testAll() {
            document.getElementById('list-result').innerHTML = '';
            document.getElementById('db-result').innerHTML = '';
            document.getElementById('format-result').innerHTML = '';
            
            await testListAPI();
            await new Promise(resolve => setTimeout(resolve, 1000));
            await testDatabaseQuery();
            await new Promise(resolve => setTimeout(resolve, 1000));
            await checkDataFormat();
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡Œ
        window.addEventListener('load', () => {
            console.log('ğŸ”§ è®¡åˆ’æ•°æ®è°ƒè¯•å·¥å…·å·²åŠ è½½');
            console.log('ç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯•');
        });
    </script>
</body>
</html>
