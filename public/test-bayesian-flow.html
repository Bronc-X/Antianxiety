<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è´å¶æ–¯æ•°æ®æµæ£€æŸ¥å·¥å…·</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      max-width: 1200px;
      margin: 40px auto;
      padding: 0 20px;
      background: #FAF6EF;
    }
    .header {
      background: linear-gradient(135deg, #0B3D2E 0%, #06261c 100%);
      color: white;
      padding: 30px;
      border-radius: 12px;
      margin-bottom: 30px;
    }
    .section {
      background: white;
      padding: 25px;
      border-radius: 12px;
      margin-bottom: 20px;
      border: 1px solid #E7E1D6;
    }
    .status {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
      margin-left: 10px;
    }
    .status.success { background: #d4edda; color: #155724; }
    .status.warning { background: #fff3cd; color: #856404; }
    .status.error { background: #f8d7da; color: #721c24; }
    .status.info { background: #d1ecf1; color: #0c5460; }
    button {
      background: linear-gradient(135deg, #0B3D2E 0%, #06261c 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      margin-right: 10px;
      margin-top: 10px;
    }
    button:hover { opacity: 0.9; }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    pre {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 8px;
      overflow-x: auto;
      font-size: 13px;
      border: 1px solid #e0e0e0;
    }
    .log {
      font-family: 'Monaco', 'Courier New', monospace;
      font-size: 12px;
      line-height: 1.6;
    }
    .check-item {
      padding: 15px;
      margin: 10px 0;
      border-left: 4px solid #E7E1D6;
      background: #fafafa;
      border-radius: 4px;
    }
    h2 { color: #0B3D2E; margin-top: 0; }
    h3 { color: #0B3D2E; font-size: 16px; }
  </style>
</head>
<body>
  <div class="header">
    <h1 style="margin:0;">ğŸ” è´å¶æ–¯æ•°æ®æµè¯Šæ–­å·¥å…·</h1>
    <p style="margin:10px 0 0 0; opacity:0.9;">æ£€æŸ¥ habit_completions â†’ trigger â†’ user_metrics æ•°æ®æµ</p>
  </div>

  <div class="section">
    <h2>æ­¥éª¤1: è¿æ¥é…ç½®</h2>
    <p>ä»æµè§ˆå™¨ç¯å¢ƒæ£€æŸ¥æ•°æ®æµï¼ˆéœ€è¦ç™»å½•ï¼‰</p>
    <button onclick="checkAuth()">æ£€æŸ¥ç™»å½•çŠ¶æ€</button>
    <div id="auth-status"></div>
  </div>

  <div class="section">
    <h2>æ­¥éª¤2: æ•°æ®è¡¨æ£€æŸ¥</h2>
    <div class="check-item">
      <h3>æ£€æŸ¥ user_metrics è¡¨</h3>
      <button onclick="checkUserMetrics()">æŸ¥è¯¢ user_metrics</button>
      <div id="metrics-result"></div>
    </div>
    <div class="check-item">
      <h3>æ£€æŸ¥ habit_completions è¡¨</h3>
      <button onclick="checkHabitCompletions()">æŸ¥è¯¢ habit_completions</button>
      <div id="completions-result"></div>
    </div>
    <div class="check-item">
      <h3>æ£€æŸ¥ habits è¡¨</h3>
      <button onclick="checkHabits()">æŸ¥è¯¢ habits</button>
      <div id="habits-result"></div>
    </div>
  </div>

  <div class="section">
    <h2>æ­¥éª¤3: è§¦å‘å™¨æµ‹è¯•</h2>
    <p>âš ï¸ æ­¤æ“ä½œä¼šåˆ›å»ºä¸€æ¡æµ‹è¯•è®°å½•</p>
    <button onclick="testTrigger()" id="test-trigger-btn">åˆ›å»ºæµ‹è¯•æ‰“å¡å¹¶æ£€æŸ¥è§¦å‘å™¨</button>
    <div id="trigger-result"></div>
  </div>

  <div class="section">
    <h2>æ­¥éª¤4: è¯Šæ–­æŠ¥å‘Š</h2>
    <button onclick="generateReport()">ç”Ÿæˆå®Œæ•´æŠ¥å‘Š</button>
    <div id="report-result"></div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.80.0/+esm';

    const supabaseUrl = 'YOUR_SUPABASE_URL'; // ä»æ§åˆ¶å°è·å–
    const supabaseKey = 'YOUR_SUPABASE_ANON_KEY'; // ä»æ§åˆ¶å°è·å–
    
    // å°è¯•ä»ç¯å¢ƒå˜é‡è¯»å–
    const envUrl = window.location.hostname === 'localhost' 
      ? 'http://localhost:3000' 
      : window.location.origin;
    
    let supabase;
    try {
      // å°è¯•ä½¿ç”¨é¡µé¢çš„é…ç½®
      const metaUrl = document.querySelector('meta[name="supabase-url"]');
      const metaKey = document.querySelector('meta[name="supabase-key"]');
      
      if (metaUrl && metaKey) {
        supabase = createClient(metaUrl.content, metaKey.content);
      }
    } catch (e) {
      console.error('Supabaseåˆå§‹åŒ–å¤±è´¥:', e);
    }

    window.checkAuth = async function() {
      const el = document.getElementById('auth-status');
      el.innerHTML = '<p class="log">æ£€æŸ¥ä¸­...</p>';
      
      if (!supabase) {
        el.innerHTML = `<div class="status error">æœªé…ç½®</div><p class="log">è¯·åœ¨é¡µé¢ä¸­æ·»åŠ  Supabase é…ç½®æˆ–åœ¨ä»£ç ä¸­è®¾ç½®URLå’ŒKey</p>`;
        return;
      }

      try {
        const { data, error } = await supabase.auth.getUser();
        if (error) throw error;
        
        if (data.user) {
          el.innerHTML = `
            <div class="status success">å·²ç™»å½•</div>
            <pre class="log">ç”¨æˆ·ID: ${data.user.id}\né‚®ç®±: ${data.user.email}</pre>
          `;
        } else {
          el.innerHTML = `<div class="status warning">æœªç™»å½•</div><p class="log">è¯·å…ˆç™»å½•åº”ç”¨</p>`;
        }
      } catch (error) {
        el.innerHTML = `<div class="status error">é”™è¯¯</div><pre class="log">${error.message}</pre>`;
      }
    };

    window.checkUserMetrics = async function() {
      const el = document.getElementById('metrics-result');
      el.innerHTML = '<p class="log">æŸ¥è¯¢ä¸­...</p>';
      
      try {
        const { data, error } = await supabase
          .from('user_metrics')
          .select('*')
          .order('date', { ascending: false })
          .limit(10);
        
        if (error) throw error;
        
        el.innerHTML = `
          <div class="status ${data.length > 0 ? 'success' : 'warning'}">
            ${data.length > 0 ? `æ‰¾åˆ° ${data.length} æ¡è®°å½•` : 'è¡¨ä¸ºç©º'}
          </div>
          <pre class="log">${JSON.stringify(data, null, 2)}</pre>
        `;
      } catch (error) {
        el.innerHTML = `<div class="status error">æŸ¥è¯¢å¤±è´¥</div><pre class="log">${error.message}</pre>`;
      }
    };

    window.checkHabitCompletions = async function() {
      const el = document.getElementById('completions-result');
      el.innerHTML = '<p class="log">æŸ¥è¯¢ä¸­...</p>';
      
      try {
        const { data, error } = await supabase
          .from('habit_completions')
          .select('*')
          .order('completed_at', { ascending: false })
          .limit(10);
        
        if (error) throw error;
        
        el.innerHTML = `
          <div class="status ${data.length > 0 ? 'success' : 'warning'}">
            ${data.length > 0 ? `æ‰¾åˆ° ${data.length} æ¡è®°å½•` : 'è¡¨ä¸ºç©º'}
          </div>
          <pre class="log">${JSON.stringify(data, null, 2)}</pre>
        `;
      } catch (error) {
        el.innerHTML = `<div class="status error">æŸ¥è¯¢å¤±è´¥</div><pre class="log">${error.message}</pre>`;
      }
    };

    window.checkHabits = async function() {
      const el = document.getElementById('habits-result');
      el.innerHTML = '<p class="log">æŸ¥è¯¢ä¸­...</p>';
      
      try {
        const { data, error } = await supabase
          .from('habits')
          .select('*')
          .limit(5);
        
        if (error) throw error;
        
        el.innerHTML = `
          <div class="status ${data.length > 0 ? 'success' : 'warning'}">
            ${data.length > 0 ? `æ‰¾åˆ° ${data.length} ä¸ªä¹ æƒ¯` : 'æ²¡æœ‰ä¹ æƒ¯'}
          </div>
          <pre class="log">${JSON.stringify(data, null, 2)}</pre>
        `;
      } catch (error) {
        el.innerHTML = `<div class="status error">æŸ¥è¯¢å¤±è´¥</div><pre class="log">${error.message}</pre>`;
      }
    };

    window.testTrigger = async function() {
      const el = document.getElementById('trigger-result');
      const btn = document.getElementById('test-trigger-btn');
      btn.disabled = true;
      el.innerHTML = '<p class="log">åˆ›å»ºæµ‹è¯•è®°å½•...</p>';
      
      try {
        // 1. è·å–å½“å‰ç”¨æˆ·
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) throw new Error('è¯·å…ˆç™»å½•');

        // 2. è·å–ä¸€ä¸ªä¹ æƒ¯
        const { data: habits, error: habitsError } = await supabase
          .from('habits')
          .select('id')
          .eq('user_id', user.id)
          .limit(1);
        
        if (habitsError) throw habitsError;
        if (!habits || habits.length === 0) throw new Error('æ²¡æœ‰æ‰¾åˆ°ä¹ æƒ¯ï¼Œè¯·å…ˆåˆ›å»ºä¹ æƒ¯');

        // 3. åˆ›å»ºæ‰“å¡è®°å½•
        const { data: completion, error: insertError } = await supabase
          .from('habit_completions')
          .insert({
            habit_id: habits[0].id,
            user_id: user.id,
            completed_at: new Date().toISOString(),
            belief_score_snapshot: 7.5
          })
          .select();
        
        if (insertError) throw insertError;

        el.innerHTML += `<div class="status success">âœ“ å·²åˆ›å»ºæ‰“å¡è®°å½•</div>`;
        el.innerHTML += `<pre class="log">${JSON.stringify(completion, null, 2)}</pre>`;

        // 4. ç­‰å¾…2ç§’ï¼Œè®©è§¦å‘å™¨æ‰§è¡Œ
        el.innerHTML += '<p class="log">ç­‰å¾…è§¦å‘å™¨æ‰§è¡Œï¼ˆ2ç§’ï¼‰...</p>';
        await new Promise(resolve => setTimeout(resolve, 2000));

        // 5. æ£€æŸ¥ user_metrics æ˜¯å¦æ›´æ–°
        const { data: metrics, error: metricsError } = await supabase
          .from('user_metrics')
          .select('*')
          .eq('user_id', user.id)
          .eq('date', new Date().toISOString().split('T')[0])
          .single();
        
        if (metricsError && metricsError.code !== 'PGRST116') throw metricsError;

        if (metrics) {
          el.innerHTML += `<div class="status success">âœ“ è§¦å‘å™¨å·¥ä½œæ­£å¸¸ï¼</div>`;
          el.innerHTML += `<pre class="log">user_metrics å·²æ›´æ–°:\n${JSON.stringify(metrics, null, 2)}</pre>`;
        } else {
          el.innerHTML += `<div class="status error">âœ— è§¦å‘å™¨æœªæ‰§è¡Œ</div>`;
          el.innerHTML += `<p class="log">user_metrics è¡¨æœªæ›´æ–°ã€‚è¯·æ£€æŸ¥è§¦å‘å™¨æ˜¯å¦åˆ›å»ºã€‚</p>`;
        }

      } catch (error) {
        el.innerHTML += `<div class="status error">æµ‹è¯•å¤±è´¥</div><pre class="log">${error.message}</pre>`;
      } finally {
        btn.disabled = false;
      }
    };

    window.generateReport = async function() {
      const el = document.getElementById('report-result');
      el.innerHTML = '<p class="log">ç”ŸæˆæŠ¥å‘Šä¸­...</p>';
      
      const report = {
        timestamp: new Date().toISOString(),
        checks: []
      };

      try {
        // æ£€æŸ¥1: ç”¨æˆ·è®¤è¯
        const { data: userData } = await supabase.auth.getUser();
        report.checks.push({
          name: 'ç”¨æˆ·è®¤è¯',
          status: userData.user ? 'success' : 'error',
          message: userData.user ? `å·²ç™»å½• (${userData.user.email})` : 'æœªç™»å½•'
        });

        if (!userData.user) {
          el.innerHTML = `<div class="status error">è¯·å…ˆç™»å½•</div>`;
          return;
        }

        // æ£€æŸ¥2: user_metrics è¡¨
        const { data: metrics, error: metricsError } = await supabase
          .from('user_metrics')
          .select('*')
          .eq('user_id', userData.user.id);
        
        report.checks.push({
          name: 'user_metrics è¡¨',
          status: metricsError ? 'error' : (metrics.length > 0 ? 'success' : 'warning'),
          message: metricsError ? metricsError.message : `${metrics.length} æ¡è®°å½•`,
          data: metrics
        });

        // æ£€æŸ¥3: habit_completions è¡¨
        const { data: completions, error: completionsError } = await supabase
          .from('habit_completions')
          .select('*')
          .eq('user_id', userData.user.id);
        
        report.checks.push({
          name: 'habit_completions è¡¨',
          status: completionsError ? 'error' : (completions.length > 0 ? 'success' : 'warning'),
          message: completionsError ? completionsError.message : `${completions.length} æ¡è®°å½•`,
          data: completions
        });

        // ç”Ÿæˆè¯Šæ–­ç»“è®º
        let conclusion = '';
        if (completions.length > 0 && metrics.length === 0) {
          conclusion = 'ğŸ”´ æ•°æ®æµé—®é¢˜ï¼šæœ‰æ‰“å¡è®°å½•ä½†æ— æŒ‡æ ‡æ•°æ®ï¼Œè§¦å‘å™¨å¯èƒ½æœªåˆ›å»ºæˆ–æœªæ‰§è¡Œ';
        } else if (completions.length > 0 && metrics.length > 0) {
          conclusion = 'âœ… æ•°æ®æµæ­£å¸¸ï¼šè§¦å‘å™¨æ­£å¸¸å·¥ä½œ';
        } else if (completions.length === 0) {
          conclusion = 'âš ï¸ æ— æµ‹è¯•æ•°æ®ï¼šè¯·å…ˆå®Œæˆä¹ æƒ¯æ‰“å¡';
        }

        report.conclusion = conclusion;

        // æ˜¾ç¤ºæŠ¥å‘Š
        el.innerHTML = `
          <h3>${conclusion}</h3>
          <pre class="log">${JSON.stringify(report, null, 2)}</pre>
        `;

      } catch (error) {
        el.innerHTML = `<div class="status error">ç”ŸæˆæŠ¥å‘Šå¤±è´¥</div><pre class="log">${error.message}</pre>`;
      }
    };

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
    window.addEventListener('load', () => {
      console.log('è´å¶æ–¯æ•°æ®æµæ£€æŸ¥å·¥å…·å·²åŠ è½½');
      console.log('è¯·åœ¨å¼€å‘è€…å·¥å…·ä¸­è®¾ç½® supabaseUrl å’Œ supabaseKey');
    });
  </script>
</body>
</html>
