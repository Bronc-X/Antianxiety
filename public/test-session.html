<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sessionæµ‹è¯•</title>
    <style>
        body {
            font-family: monospace;
            max-width: 1000px;
            margin: 50px auto;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
        }
        h1 { color: #4ec9b0; }
        button {
            padding: 10px 20px;
            background: #0e639c;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 5px;
            font-size: 14px;
        }
        button:hover { background: #1177bb; }
        pre {
            background: #252526;
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #3c3c3c;
            overflow-x: auto;
        }
        .success { color: #4ec9b0; }
        .error { color: #f48771; }
        .warning { color: #dcdcaa; }
    </style>
</head>
<body>
    <h1>ğŸ” Session & Cookie æµ‹è¯•</h1>
    
    <div>
        <button onclick="testCookies()">1. æ£€æŸ¥ Cookies</button>
        <button onclick="testSession()">2. æµ‹è¯• Session</button>
        <button onclick="testAuth()">3. æµ‹è¯•è®¤è¯çŠ¶æ€</button>
        <button onclick="testRedirect()">4. æµ‹è¯•è·³è½¬åˆ° Dashboard</button>
        <button onclick="clearAll()">æ¸…é™¤æ‰€æœ‰</button>
    </div>

    <h2>ç»“æœï¼š</h2>
    <pre id="result"></pre>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

        const supabaseUrl = 'YOUR_SUPABASE_URL';
        const supabaseKey = 'YOUR_SUPABASE_ANON_KEY';
        
        // ä»ç¯å¢ƒè·å–é…ç½®ï¼ˆå¦‚æœå¯èƒ½ï¼‰
        let supabase;
        try {
            supabase = createClient(
                supabaseUrl || window.location.origin,
                supabaseKey || 'temp-key'
            );
        } catch (e) {
            console.error('Supabaseåˆå§‹åŒ–å¤±è´¥:', e);
        }

        function log(message, type = 'info') {
            const result = document.getElementById('result');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : 'warning';
            result.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
        }

        window.testCookies = function() {
            document.getElementById('result').innerHTML = '';
            log('=== æ£€æŸ¥ Cookies ===', 'info');
            
            const cookies = document.cookie.split(';');
            log(`å…±æœ‰ ${cookies.length} ä¸ª cookie`, 'info');
            
            let hasSupabaseCookie = false;
            cookies.forEach(cookie => {
                const [name, value] = cookie.trim().split('=');
                log(`  ${name}: ${value.substring(0, 50)}${value.length > 50 ? '...' : ''}`, 'info');
                
                if (name.startsWith('sb-')) {
                    hasSupabaseCookie = true;
                }
            });
            
            if (hasSupabaseCookie) {
                log('\nâœ… å‘ç° Supabase Cookie', 'success');
            } else {
                log('\nâŒ æœªå‘ç° Supabase Cookie', 'error');
                log('å¯èƒ½çš„åŸå› ï¼š', 'warning');
                log('1. ç”¨æˆ·æœªç™»å½•', 'warning');
                log('2. Cookieå·²è¿‡æœŸ', 'warning');
                log('3. Cookieè¢«æ¸…é™¤', 'warning');
            }
        };

        window.testSession = async function() {
            document.getElementById('result').innerHTML = '';
            log('=== æµ‹è¯• Session ===', 'info');
            
            if (!supabase) {
                log('âŒ Supabaseå®¢æˆ·ç«¯æœªåˆå§‹åŒ–', 'error');
                return;
            }
            
            try {
                log('ğŸ“¤ è·å–Session...', 'info');
                const { data, error } = await supabase.auth.getSession();
                
                if (error) {
                    log(`âŒ è·å–Sessionå¤±è´¥: ${error.message}`, 'error');
                    return;
                }
                
                if (data.session) {
                    log('âœ… Sessionæœ‰æ•ˆï¼', 'success');
                    log(`\nç”¨æˆ·ä¿¡æ¯:`, 'info');
                    log(`  ID: ${data.session.user.id}`, 'info');
                    log(`  Email: ${data.session.user.email}`, 'info');
                    log(`  Access Token: ${data.session.access_token.substring(0, 50)}...`, 'info');
                    log(`  Expires: ${new Date(data.session.expires_at * 1000).toLocaleString()}`, 'info');
                } else {
                    log('âŒ Sessionä¸ºç©ºï¼Œç”¨æˆ·æœªç™»å½•', 'error');
                }
            } catch (err) {
                log(`âŒ æµ‹è¯•å¤±è´¥: ${err.message}`, 'error');
            }
        };

        window.testAuth = async function() {
            document.getElementById('result').innerHTML = '';
            log('=== æµ‹è¯•è®¤è¯çŠ¶æ€ ===', 'info');
            
            try {
                log('ğŸ“¤ æ£€æŸ¥è®¤è¯çŠ¶æ€...', 'info');
                const response = await fetch('/api/plans/list?status=active&limit=1');
                log(`HTTPçŠ¶æ€: ${response.status}`, 'info');
                
                if (response.status === 401) {
                    log('âŒ æœªè®¤è¯ - éœ€è¦ç™»å½•', 'error');
                } else if (response.ok) {
                    const data = await response.json();
                    log('âœ… å·²è®¤è¯ï¼', 'success');
                    log(`APIå“åº”: ${JSON.stringify(data, null, 2)}`, 'info');
                } else {
                    log(`âš ï¸ çŠ¶æ€å¼‚å¸¸: ${response.status}`, 'warning');
                }
            } catch (err) {
                log(`âŒ æµ‹è¯•å¤±è´¥: ${err.message}`, 'error');
            }
        };

        window.testRedirect = function() {
            document.getElementById('result').innerHTML = '';
            log('=== æµ‹è¯•è·³è½¬ ===', 'info');
            log('ğŸš€ 3ç§’åè·³è½¬åˆ° /dashboard...', 'warning');
            
            setTimeout(() => {
                window.location.href = '/dashboard';
            }, 3000);
        };

        window.clearAll = function() {
            document.getElementById('result').innerHTML = '';
            log('å·²æ¸…é™¤ç»“æœ', 'info');
        };
    </script>
</body>
</html>
