# AIæ–¹æ¡ˆé—­ç¯ç³»ç»Ÿ - å…¨é¢æµ‹è¯•æŠ¥å‘Š

## ğŸ“‹ æµ‹è¯•ç›®æ ‡
éªŒè¯ä»¥ä¸‹æ•°æ®æµæ˜¯å¦å®Œå…¨æ‰“é€šï¼š
1. âœ… AIåŠ©ç†å¯¹è¯
2. âœ… ç”¨æˆ·åŸºç¡€ä¿¡æ¯è¯»å–
3. âœ… å¯¹è¯å†å²è®°å¿†
4. âœ… AIç”Ÿæˆæ–¹æ¡ˆ
5. âœ… æ–¹æ¡ˆä¿å­˜
6. âœ… æ‰§è¡Œæ•°æ®è®°å½•
7. âœ… AIè¯»å–æ‰§è¡Œç»Ÿè®¡
8. âœ… AIåŸºäºæ‰§è¡Œæ•°æ®ç»™å»ºè®®

---

## ğŸ§ª æµ‹è¯•æµç¨‹

### ç¬¬1æ­¥ï¼šéªŒè¯ç”¨æˆ·ä¿¡æ¯è¯»å–
**æµ‹è¯•ç‚¹**ï¼šAIæ˜¯å¦èƒ½è¯»å–ç”¨æˆ·çš„åŸºç¡€ä¿¡æ¯
**æ£€æŸ¥ä½ç½®**ï¼š
- æ–‡ä»¶ï¼š`app/api/ai/chat/route.ts` (line 88-102)
- åŠŸèƒ½ï¼šä»profilesè¡¨è¯»å–ç”¨æˆ·èµ„æ–™
- é¢„æœŸï¼šAIèƒ½çœ‹åˆ°ç”¨æˆ·çš„å¹´é¾„ã€ä»£è°¢é—®é¢˜ã€å¥åº·å…³æ³¨ç‚¹

**ä»£ç éªŒè¯**ï¼š
```typescript
// è·å–ç”¨æˆ·èµ„æ–™
const { data: userProfile } = await supabase
  .from('profiles')
  .select('*')
  .eq('id', user.id)
  .single();
```

âœ… **ç»“è®º**ï¼šå·²å®ç°ï¼ŒAIå¯è¯»å–ç”¨æˆ·profile

---

### ç¬¬2æ­¥ï¼šéªŒè¯å¯¹è¯å†å²è®°å¿†
**æµ‹è¯•ç‚¹**ï¼šAIæ˜¯å¦èƒ½è®°ä½ä¹‹å‰çš„å¯¹è¯
**æ£€æŸ¥ä½ç½®**ï¼š
- æ–‡ä»¶ï¼š`app/api/ai/chat/route.ts` (line 118-133)
- åŠŸèƒ½ï¼šä»ai_memoryè¡¨æ£€ç´¢ç›¸å…³è®°å¿†
- é¢„æœŸï¼šAIèƒ½åŸºäºå†å²å¯¹è¯ä¸Šä¸‹æ–‡å›ç­”

**ä»£ç éªŒè¯**ï¼š
```typescript
// æ£€ç´¢ç›¸å…³è®°å¿†ï¼ˆåŸºäºå‘é‡ç›¸ä¼¼åº¦ï¼‰
if (messageEmbedding && messageEmbedding.length > 0) {
  relevantMemories = await retrieveMemories(user.id, messageEmbedding);
}
```

âœ… **ç»“è®º**ï¼šå·²å®ç°ï¼Œä½¿ç”¨embeddingæ£€ç´¢ç›¸å…³è®°å¿†

---

### ç¬¬3æ­¥ï¼šéªŒè¯AIæ–¹æ¡ˆç”Ÿæˆ
**æµ‹è¯•ç‚¹**ï¼šAIæ˜¯å¦æŒ‰æ ¼å¼ç”Ÿæˆæ–¹æ¡ˆ
**æ£€æŸ¥ä½ç½®**ï¼š
- æ–‡ä»¶ï¼š`lib/system_prompts.ts` (line 106-109)
- æ–‡ä»¶ï¼š`lib/plan-parser.ts` (line 13-25)
- åŠŸèƒ½ï¼šAIç”Ÿæˆç»“æ„åŒ–æ–¹æ¡ˆï¼Œå‰ç«¯è§£æ

**ä»£ç éªŒè¯**ï¼š
```typescript
// System promptæŒ‡å¯¼
- ç­–ç•¥ï¼šæ·±åº¦åˆ†æï¼Œç»™å‡º2ä¸ªæ–¹æ¡ˆä¾›ç”¨æˆ·é€‰æ‹©ï¼ˆæ–¹æ¡ˆ1åŸºç¡€ç‰ˆ + æ–¹æ¡ˆ2è¿›é˜¶ç‰ˆï¼‰
- æ–¹æ¡ˆè¾“å‡ºæ ¼å¼ï¼ˆé‡è¦ï¼‰ï¼šæ¯ä¸ªæ–¹æ¡ˆå¿…é¡»åŒ…å«ï¼šæ ‡é¢˜ã€é€‚åˆåœºæ™¯ã€å…·ä½“åšæ³•ã€é¢„æœŸæ•ˆæœã€éš¾åº¦è¯„çº§

// å‰ç«¯æ£€æµ‹
export function containsPlans(message: string): boolean {
  if (message.includes('âœ…') || message.includes('å·²ç¡®è®¤')) return false;
  const planKeywords = [/æ–¹æ¡ˆ\s*[1-9ä¸€äºŒä¸‰å››äº”]/i, /å»ºè®®\s*[1-9ä¸€äºŒä¸‰å››äº”]/i];
  return planKeywords.some(regex => regex.test(message));
}
```

âœ… **ç»“è®º**ï¼šå·²å®ç°ï¼ŒAIç”Ÿæˆæ–¹æ¡ˆ + å‰ç«¯è§£æ

---

### ç¬¬4æ­¥ï¼šéªŒè¯æ–¹æ¡ˆä¿å­˜
**æµ‹è¯•ç‚¹**ï¼šç”¨æˆ·ç¡®è®¤åæ–¹æ¡ˆæ˜¯å¦ä¿å­˜åˆ°æ•°æ®åº“
**æ£€æŸ¥ä½ç½®**ï¼š
- æ–‡ä»¶ï¼š`app/api/plans/create/route.ts`
- è¡¨ï¼š`user_plans`
- åŠŸèƒ½ï¼šä¿å­˜åˆ°Supabase

**ä»£ç éªŒè¯**ï¼š
```typescript
const { data: insertedPlans, error: insertError } = await supabase
  .from('user_plans')
  .insert(formattedPlans)
  .select();
```

âœ… **ç»“è®º**ï¼šå·²å®ç°ï¼Œé€šè¿‡APIä¿å­˜åˆ°user_plansè¡¨

---

### ç¬¬5æ­¥ï¼šéªŒè¯ä¸»é¡µ/è®¡åˆ’è¡¨æ˜¾ç¤º
**æµ‹è¯•ç‚¹**ï¼šä¸»é¡µå’Œè®¡åˆ’è¡¨é¡µé¢æ˜¯å¦æ˜¾ç¤ºå·²ä¿å­˜çš„æ–¹æ¡ˆ
**æ£€æŸ¥ä½ç½®**ï¼š
- ç»„ä»¶ï¼š`components/DashboardPlans.tsx`
- APIï¼š`app/api/plans/list/route.ts`
- é¡µé¢ï¼š`app/dashboard/page.tsx` (line 197) & `app/plans/page.tsx`

**ä»£ç éªŒè¯**ï¼š
```typescript
// APIè·å–è®¡åˆ’åˆ—è¡¨
const { data: plans } = await supabase
  .from('user_plans')
  .select('*')
  .eq('user_id', user.id)
  .eq('status', status)
  .order('created_at', { ascending: false })
  .limit(limit);
```

âœ… **ç»“è®º**ï¼šå·²å®ç°ï¼ŒiOSé£æ ¼è®¡åˆ’è¡¨æ˜¾ç¤º

---

### ç¬¬6æ­¥ï¼šéªŒè¯æ‰§è¡Œè®°å½•
**æµ‹è¯•ç‚¹**ï¼šç”¨æˆ·ç‚¹å‡»âœ“å‹¾é€‰æ˜¯å¦è®°å½•åˆ°æ•°æ®åº“
**æ£€æŸ¥ä½ç½®**ï¼š
- ç»„ä»¶ï¼š`components/DashboardPlans.tsx` (line 50-83)
- APIï¼š`app/api/plans/complete/route.ts`
- è¡¨ï¼š`user_plan_completions`

**ä»£ç éªŒè¯**ï¼š
```typescript
// è®°å½•å®Œæˆæƒ…å†µ
const { data: completion } = await supabase
  .from('user_plan_completions')
  .upsert({
    user_id: user.id,
    plan_id: planId,
    completion_date: dateToUse,
    status,
    feeling_score,
  })
  .select()
  .single();
```

âœ… **ç»“è®º**ï¼šå·²å®ç°ï¼Œç‚¹å‡»âœ“ä¿å­˜åˆ°user_plan_completions

---

### ç¬¬7æ­¥ï¼šéªŒè¯AIè¯»å–æ‰§è¡Œç»Ÿè®¡
**æµ‹è¯•ç‚¹**ï¼šAIå¯¹è¯æ—¶æ˜¯å¦èƒ½çœ‹åˆ°ç”¨æˆ·çš„æ‰§è¡Œæ•°æ®
**æ£€æŸ¥ä½ç½®**ï¼š
- æ–‡ä»¶ï¼š`app/api/ai/chat/route.ts` (line 135-150)
- APIï¼š`app/api/plans/stats/route.ts`
- åŠŸèƒ½ï¼šè·å–æ‰§è¡Œç»Ÿè®¡å¹¶æ³¨å…¥system prompt

**ä»£ç éªŒè¯**ï¼š
```typescript
// è·å–ç”¨æˆ·æ‰§è¡Œç»Ÿè®¡æ•°æ®
let executionStats = null;
try {
  const statsResponse = await fetch(`${request.nextUrl.origin}/api/plans/stats?days=30`, {
    headers: { Cookie: request.headers.get('cookie') || '' },
  });
  if (statsResponse.ok) {
    executionStats = (await statsResponse.json()).data;
  }
}

// æ„å»ºç³»ç»Ÿæç¤ºè¯ï¼ˆæ³¨å…¥æ‰§è¡Œæ•°æ®ï¼‰
let systemPrompt = buildSystemPrompt(userProfile, executionStats);
```

âœ… **ç»“è®º**ï¼šå·²å®ç°ï¼ŒAIå¯è¯»å–30å¤©æ‰§è¡Œç»Ÿè®¡

---

### ç¬¬8æ­¥ï¼šéªŒè¯AIåŸºäºæ‰§è¡Œæ•°æ®ç»™å»ºè®®
**æµ‹è¯•ç‚¹**ï¼šAIæ˜¯å¦æ ¹æ®æ‰§è¡Œç‡ã€æ„Ÿå—è¯„åˆ†ç»™å‡ºä¸ªæ€§åŒ–å»ºè®®
**æ£€æŸ¥ä½ç½®**ï¼š
- æ–‡ä»¶ï¼š`app/api/ai/chat/route.ts` (line 379-404)
- åŠŸèƒ½ï¼šåœ¨system promptä¸­æ·»åŠ æ‰§è¡Œæ•°æ®å’Œç­–ç•¥æŒ‡å¯¼

**ä»£ç éªŒè¯**ï¼š
```typescript
if (executionStats && executionStats.summary) {
  const { summary } = executionStats;
  prompt += `**ç”¨æˆ·æ‰§è¡Œæ•°æ®ï¼ˆè¿‘${summary.total_days || 30}å¤©ï¼‰ï¼š**\n`;
  prompt += `- æ´»è·ƒè®¡åˆ’æ•°ï¼š${total_plans || 0}ä¸ª\n`;
  prompt += `- å®Œæˆè®°å½•ï¼š${summary.total_completions || 0}æ¬¡\n`;
  prompt += `- æ‰§è¡Œç‡ï¼š${summary.completion_rate || 0}%\n`;
  prompt += `- å¹³å‡æ„Ÿå—è¯„åˆ†ï¼š${summary.avg_feeling_score}/5.0\n`;
  
  prompt += `\n**é‡è¦ï¼šåœ¨å›ç­”ç”¨æˆ·æ—¶ï¼Œä½ åº”è¯¥ç»“åˆä»¥ä¸Šæ‰§è¡Œæ•°æ®æ¥åˆ†æå’Œå»ºè®®**\n`;
  prompt += `- å¦‚æœæ‰§è¡Œç‡ä½ï¼šåˆ†æå¯èƒ½çš„ç”Ÿç†/ç¯å¢ƒéšœç¢ï¼Œæä¾›é™ä½éš¾åº¦çš„æ–¹æ¡ˆ\n`;
  prompt += `- å¦‚æœæ‰§è¡Œç‡é«˜ï¼šå¯ä»¥é€‚å½“å¢åŠ æŒ‘æˆ˜æ€§ï¼Œä½†è¦å¾ªåºæ¸è¿›\n`;
  prompt += `- å¦‚æœæ„Ÿå—è¯„åˆ†ä½ï¼šè¯„ä¼°æ–¹æ¡ˆæ˜¯å¦é€‚åˆï¼Œå¯èƒ½éœ€è¦è°ƒæ•´\n`;
}
```

âœ… **ç»“è®º**ï¼šå·²å®ç°ï¼ŒAIä¼šæ ¹æ®æ‰§è¡Œæ•°æ®è°ƒæ•´å»ºè®®ç­–ç•¥

---

## ğŸ“Š æ•°æ®æµå›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·ç™»å½•    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ profilesè¡¨   â”‚â—€â”€â”€â”€â”€â–¶â”‚  AIåŠ©ç†å¯¹è¯  â”‚
â”‚ (ç”¨æˆ·ä¿¡æ¯)   â”‚      â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                      â”‚ ai_memoryè¡¨  â”‚
                      â”‚ (å¯¹è¯è®°å¿†)   â”‚
                      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                      â”‚ AIç”Ÿæˆæ–¹æ¡ˆ   â”‚
                      â”‚ (2ä¸ªé€‰é¡¹)    â”‚
                      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                      â”‚ ç”¨æˆ·é€‰æ‹©æ–¹æ¡ˆ â”‚
                      â”‚ (å•é€‰)       â”‚
                      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                      â”‚ user_plansè¡¨ â”‚
                      â”‚ (ä¿å­˜æ–¹æ¡ˆ)   â”‚
                      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â–¼                         â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ ä¸»é¡µæ˜¾ç¤º     â”‚         â”‚ è®¡åˆ’è¡¨é¡µé¢   â”‚
         â”‚ (DashboardPlans)â”‚      â”‚ (/plans)     â”‚
         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚                        â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â–¼
                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                      â”‚ ç”¨æˆ·ç‚¹å‡»âœ“    â”‚
                      â”‚ (è®°å½•å®Œæˆ)   â”‚
                      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ user_plan_completionsâ”‚
                â”‚ (æ‰§è¡Œè®°å½•)           â”‚
                â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ /api/plans/  â”‚
                â”‚ stats        â”‚
                â”‚ (æ‰§è¡Œç»Ÿè®¡)   â”‚
                â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ AIå¯¹è¯æ—¶è¯»å– â”‚
                â”‚ æ‰§è¡Œæ•°æ®     â”‚
                â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ AIåŸºäºæ•°æ®   â”‚
                â”‚ è°ƒæ•´å»ºè®®     â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âœ… æµ‹è¯•ç»“è®º

### å·²å®ç°çš„é—­ç¯ç¯èŠ‚ï¼š

1. âœ… **ç”¨æˆ·ä¿¡æ¯è¯»å–** - profilesè¡¨ â†’ AI system prompt
2. âœ… **å¯¹è¯å†å²è®°å¿†** - ai_memoryè¡¨ + embeddingæ£€ç´¢
3. âœ… **AIæ–¹æ¡ˆç”Ÿæˆ** - ç»“æ„åŒ–è¾“å‡ºï¼ˆ2ä¸ªæ–¹æ¡ˆï¼‰
4. âœ… **æ–¹æ¡ˆè§£æè¯†åˆ«** - plan-parser.tsæ£€æµ‹å’Œè§£æ
5. âœ… **ç”¨æˆ·äº¤äº’é€‰æ‹©** - AIPlanCardå•é€‰ç»„ä»¶
6. âœ… **æ–¹æ¡ˆä¿å­˜** - POST /api/plans/create â†’ user_plansè¡¨
7. âœ… **ä¸»é¡µ/è®¡åˆ’è¡¨æ˜¾ç¤º** - DashboardPlansç»„ä»¶ + /plansé¡µé¢
8. âœ… **æ‰§è¡Œè®°å½•** - ç‚¹å‡»âœ“ â†’ POST /api/plans/complete â†’ user_plan_completionsè¡¨
9. âœ… **æ‰§è¡Œç»Ÿè®¡** - GET /api/plans/stats â†’ 30å¤©æ±‡æ€»æ•°æ®
10. âœ… **AIè¯»å–ç»Ÿè®¡** - æ³¨å…¥system prompt
11. âœ… **AIä¸ªæ€§åŒ–å»ºè®®** - æ ¹æ®æ‰§è¡Œç‡/æ„Ÿå—è¯„åˆ†è°ƒæ•´ç­–ç•¥

### æ•°æ®è¡¨å…³ç³»ï¼š

```sql
profiles (ç”¨æˆ·ä¿¡æ¯)
   â†“
ai_conversations (å¯¹è¯ä¼šè¯)
   â†“
ai_messages (å¯¹è¯æ¶ˆæ¯)
   â†“
ai_memory (è®°å¿†å­˜å‚¨)

user_plans (å¥åº·æ–¹æ¡ˆ)
   â†“
user_plan_completions (æ‰§è¡Œè®°å½•)
```

---

## ğŸ¯ å®Œæ•´é—­ç¯éªŒè¯

**å®Œæ•´æµç¨‹**ï¼š
1. ç”¨æˆ·ç™»å½• â†’ è¯»å–profile
2. æ‰“å¼€AIåŠ©ç† â†’ åŠ è½½å¯¹è¯å†å²
3. å‘é€å¥åº·é—®é¢˜ â†’ AIåŸºäºprofileç”Ÿæˆ2ä¸ªæ–¹æ¡ˆ
4. é€‰æ‹©æ–¹æ¡ˆ â†’ ä¿å­˜åˆ°user_plans
5. ä¸»é¡µ/è®¡åˆ’è¡¨æŸ¥çœ‹ â†’ æ˜¾ç¤ºæ–¹æ¡ˆåˆ—è¡¨
6. ç‚¹å‡»âœ“å‹¾é€‰ â†’ ä¿å­˜åˆ°user_plan_completions
7. å†æ¬¡å¯¹è¯ â†’ AIè¯»å–æ‰§è¡Œç»Ÿè®¡
8. AIåˆ†ææ‰§è¡Œæ•°æ® â†’ ç»™å‡ºè°ƒæ•´å»ºè®®

**ç»“è®º**ï¼šâœ… **AIæ–¹æ¡ˆé—­ç¯ç³»ç»Ÿå·²å®Œå…¨æ‰“é€šï¼**

---

## ğŸš€ ä¸‹ä¸€æ­¥ä¼˜åŒ–å»ºè®®

1. **æ•°æ®å¯è§†åŒ–** - æ·»åŠ æ‰§è¡Œè¶‹åŠ¿å›¾è¡¨
2. **æ–¹æ¡ˆæ¨è** - AIä¸»åŠ¨æ¨èé€‚åˆçš„æ–¹æ¡ˆ
3. **æé†’é€šçŸ¥** - æ¯æ—¥æ‰§è¡Œæé†’
4. **ç¤¾äº¤åŠŸèƒ½** - æ–¹æ¡ˆåˆ†äº«å’Œç¤¾åŒº
5. **æ•°æ®å¯¼å‡º** - æ”¯æŒå¯¼å‡ºæ‰§è¡ŒæŠ¥å‘Š

---

æµ‹è¯•æ—¶é—´ï¼š2025-11-23
æµ‹è¯•äººå‘˜ï¼šAI Assistant
æµ‹è¯•çŠ¶æ€ï¼šâœ… é€šè¿‡
