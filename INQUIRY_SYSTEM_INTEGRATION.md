# Active Inquiry System Integration

## æ¦‚è¿°

Active Inquiry Banner ç³»ç»Ÿç°å·²å®Œå…¨é›†æˆåˆ°æ•´ä¸ªåº”ç”¨ç”Ÿæ€ä¸­ï¼Œå®ç°äº†æ•°æ®çš„åŒå‘æµåŠ¨å’Œæ™ºèƒ½æ¨èã€‚

## ğŸ”„ ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Active Inquiry Banner                      â”‚
â”‚              (ç”¨æˆ·ä¸»åŠ¨å¡«å†™å¥åº·æ•°æ®)                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              /api/inquiry/respond                            â”‚
â”‚         (å¤„ç†ç”¨æˆ·å›ç­” + æ•°æ®åŒæ­¥)                             â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                      â”‚
       â–¼                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ inquiry_     â”‚      â”‚ daily_           â”‚
â”‚ history      â”‚      â”‚ calibrations     â”‚
â”‚ (è®°å½•å†å²)    â”‚      â”‚ (åŒæ­¥æ•°æ®)        â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                     â”‚
       â”‚                     â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              lib/inquiry-context.ts                          â”‚
â”‚         (æå–æ´å¯Ÿ + ç”Ÿæˆå»ºè®®ä¸»é¢˜)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                      â”‚
       â–¼                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ /api/chat    â”‚      â”‚ /api/curated-    â”‚
â”‚ (AI å¯¹è¯)     â”‚      â”‚ feed (å†…å®¹æ¨è)   â”‚
â”‚              â”‚      â”‚                  â”‚
â”‚ â€¢ è°ƒæ•´è¯­æ°”    â”‚      â”‚ â€¢ è°ƒæ•´æ ‡ç­¾        â”‚
â”‚ â€¢ ä¸ªæ€§åŒ–å»ºè®®  â”‚      â”‚ â€¢ ä¼˜å…ˆçº§æ’åº      â”‚
â”‚ â€¢ ä¸Šä¸‹æ–‡æ„ŸçŸ¥  â”‚      â”‚ â€¢ ä¸»é¢˜è¿‡æ»¤        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## âœ… å·²å®ç°çš„åŠŸèƒ½

### 1. æ•°æ®åŒæ­¥åˆ° daily_calibrations

**æ–‡ä»¶**: `app/api/inquiry/respond/route.ts`

å½“ç”¨æˆ·å›ç­” inquiry é—®é¢˜æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å°†å›ç­”æ˜ å°„åˆ° `daily_calibrations` è¡¨ï¼š

| Inquiry å­—æ®µ | æ˜ å°„åˆ° | å€¼æ˜ å°„ |
|-------------|--------|--------|
| `sleep_hours` | `sleep_hours` | under_6 â†’ 5, 6_7 â†’ 6.5, 7_8 â†’ 7.5, over_8 â†’ 8.5 |
| `stress_level` | `stress_level` | low â†’ 3, medium â†’ 6, high â†’ 9 |
| `exercise_duration` | `exercise_duration` | none â†’ 0, light â†’ 15, moderate â†’ 30, intense â†’ 60 |
| `mood` | `mood_score` | bad â†’ 3, okay â†’ 6, great â†’ 9 |
| `meal_quality` | `meal_quality` | ç›´æ¥å­˜å‚¨æ–‡æœ¬å€¼ |
| `water_intake` | `water_intake` | ç›´æ¥å­˜å‚¨æ–‡æœ¬å€¼ |

**ç¤ºä¾‹**:
```typescript
// ç”¨æˆ·å›ç­”: "æ˜¨æ™šç¡äº† 7-8 å°æ—¶"
// ç³»ç»Ÿè‡ªåŠ¨å†™å…¥:
{
  user_id: "xxx",
  date: "2025-12-23",
  sleep_hours: 7.5,
  updated_at: "2025-12-23T10:30:00Z"
}
```

### 2. Inquiry ä¸Šä¸‹æ–‡æå–

**æ–‡ä»¶**: `lib/inquiry-context.ts`

æä¾›ä¸¤ä¸ªæ ¸å¿ƒå‡½æ•°ï¼š

#### `getInquiryContext(userId: string)`

è¿”å›ç”¨æˆ·çš„ inquiry æ´å¯Ÿï¼š

```typescript
{
  insights: {
    recentSleepPattern: 'poor' | 'average' | 'good' | null,
    recentStressLevel: 'low' | 'medium' | 'high' | null,
    recentExercise: 'none' | 'light' | 'moderate' | 'intense' | null,
    recentMood: 'bad' | 'okay' | 'great' | null,
    lastInquiryTime: string | null,
    totalResponses: number,
    responseRate: number // 0-1
  },
  recentResponses: [
    {
      question: "æ˜¨æ™šç¡å¾—æ€ä¹ˆæ ·ï¼Ÿ",
      response: "under_6",
      timestamp: "2025-12-23T08:00:00Z",
      dataGap: "sleep_hours"
    }
  ],
  suggestedTopics: ['sleep_optimization', 'stress_management', ...]
}
```

#### `generateInquirySummary(context, language)`

ç”Ÿæˆè‡ªç„¶è¯­è¨€æ‘˜è¦ï¼Œç”¨äº AI ç³»ç»Ÿæç¤ºï¼š

```
ç”¨æˆ·æœ€è¿‘çš„çŠ¶æ€ï¼š
- ç¡çœ ï¼šç¡çœ ä¸è¶³ï¼ˆå°‘äº6å°æ—¶ï¼‰
- å‹åŠ›ï¼šå‹åŠ›è¾ƒå¤§
- è¿åŠ¨ï¼šæœªè¿åŠ¨
- æƒ…ç»ªï¼šå¿ƒæƒ…ä¸€èˆ¬

å“åº”ç‡ï¼š80%
```

### 3. AI å¯¹è¯é›†æˆ

**æ–‡ä»¶**: `app/api/chat/route.ts`

AI å¯¹è¯ç°åœ¨ä¼šè¯»å– inquiry ä¸Šä¸‹æ–‡ï¼š

```typescript
// åœ¨æ„å»ºç³»ç»Ÿæç¤ºæ—¶
const inquiryContext = await getInquiryContext(userId);
const inquirySummary = generateInquirySummary(inquiryContext, 'zh');

// æ·»åŠ åˆ°ç³»ç»Ÿæç¤º
[ACTIVE INQUIRY INSIGHTS - ä¸»åŠ¨è¯¢é—®æ´å¯Ÿ]
ç”¨æˆ·æœ€è¿‘çš„çŠ¶æ€ï¼š
- ç¡çœ ï¼šç¡çœ ä¸è¶³ï¼ˆå°‘äº6å°æ—¶ï¼‰
- å‹åŠ›ï¼šå‹åŠ›è¾ƒå¤§

âš ï¸ AI æŒ‡å¯¼ï¼šæ ¹æ®ç”¨æˆ·æœ€è¿‘çš„ä¸»åŠ¨è¯¢é—®å›ç­”ï¼Œè°ƒæ•´å¯¹è¯ç­–ç•¥å’Œå»ºè®®å†…å®¹ã€‚
```

**æ•ˆæœ**:
- AI ä¼šçŸ¥é“ç”¨æˆ·æœ€è¿‘ç¡çœ ä¸è¶³ï¼Œé¿å…æ¨èé«˜å¼ºåº¦æ´»åŠ¨
- AI ä¼šæ ¹æ®å‹åŠ›æ°´å¹³è°ƒæ•´è¯­æ°”å’Œå»ºè®®
- AI å¯ä»¥ä¸»åŠ¨å…³å¿ƒç”¨æˆ·çš„çŠ¶æ€å˜åŒ–

### 4. å†…å®¹æ¨èé›†æˆ

**æ–‡ä»¶**: `app/api/curated-feed/route.ts`

å†…å®¹æ¨èç³»ç»Ÿç°åœ¨ä¼šæ ¹æ® inquiry æ´å¯Ÿè°ƒæ•´æ¨èç­–ç•¥ï¼š

| Inquiry æ´å¯Ÿ | æ¨èè°ƒæ•´ |
|-------------|---------|
| ç¡çœ ä¸è¶³ (`recentSleepPattern: 'poor'`) | æ·»åŠ æ ‡ç­¾ "ç¡çœ é—®é¢˜"ï¼Œä¼˜å…ˆæ¨è sleep_optimization, circadian_rhythm ä¸»é¢˜ |
| é«˜å‹åŠ› (`recentStressLevel: 'high'`) | æ·»åŠ æ ‡ç­¾ "é«˜çš®è´¨é†‡é£é™©"ï¼Œä¼˜å…ˆæ¨è stress_management, cortisol_regulation ä¸»é¢˜ |
| ç¼ºä¹è¿åŠ¨ (`recentExercise: 'none'`) | ä¼˜å…ˆæ¨è exercise_benefits, zone2_cardio ä¸»é¢˜ |
| æƒ…ç»ªä¸ä½³ (`recentMood: 'bad'`) | æ·»åŠ æ ‡ç­¾ "æƒ…ç»ªå›°æ‰°"ï¼Œä¼˜å…ˆæ¨è mental_health, neurotransmitters ä¸»é¢˜ |

**ç¤ºä¾‹æ—¥å¿—**:
```
ğŸ“‹ Inquiry: æ£€æµ‹åˆ°ç¡çœ ä¸è¶³ï¼Œä¼˜å…ˆæ¨èç¡çœ ç›¸å…³å†…å®¹
ğŸ“‹ Inquiry: æ£€æµ‹åˆ°é«˜å‹åŠ›ï¼Œä¼˜å…ˆæ¨èå‹åŠ›ç®¡ç†å†…å®¹
ğŸ“‹ Inquiry å»ºè®®ä¸»é¢˜: sleep_optimization, stress_management, breathing_exercises
```

## ğŸ¯ æ•°æ®æµç¤ºä¾‹

### åœºæ™¯ï¼šç”¨æˆ·å›ç­”ç¡çœ é—®é¢˜

1. **ç”¨æˆ·æ“ä½œ**: åœ¨ Banner ä¸­é€‰æ‹© "ä¸åˆ°6å°æ—¶"
   
2. **API å¤„ç†** (`/api/inquiry/respond`):
   ```typescript
   // æ›´æ–° inquiry_history
   UPDATE inquiry_history 
   SET user_response = 'under_6', responded_at = NOW()
   WHERE id = 'inquiry_123'
   
   // åŒæ­¥åˆ° daily_calibrations
   UPSERT daily_calibrations 
   SET sleep_hours = 5, updated_at = NOW()
   WHERE user_id = 'user_456' AND date = '2025-12-23'
   ```

3. **ä¸Šä¸‹æ–‡æå–** (`lib/inquiry-context.ts`):
   ```typescript
   insights.recentSleepPattern = 'poor'
   suggestedTopics.push('sleep_optimization', 'circadian_rhythm')
   ```

4. **AI å¯¹è¯å½±å“** (`/api/chat`):
   ```
   ç”¨æˆ·: "æˆ‘ä»Šå¤©åº”è¯¥åšä»€ä¹ˆè¿åŠ¨ï¼Ÿ"
   
   AI (æœ‰ inquiry ä¸Šä¸‹æ–‡):
   "æ³¨æ„åˆ°ä½ æ˜¨æ™šç¡çœ ä¸è¶³ï¼ˆå°‘äº6å°æ—¶ï¼‰ã€‚ä»Šå¤©å»ºè®®é¿å…é«˜å¼ºåº¦è®­ç»ƒï¼Œ
   å¯ä»¥å°è¯•è½»åº¦æ‹‰ä¼¸æˆ–æ•£æ­¥ï¼Œå¸®åŠ©èº«ä½“æ¢å¤ã€‚æ™šä¸Šè®°å¾—æå‰è°ƒæš—ç¯å…‰ï¼Œ
   ä¸ºä»Šæ™šçš„ç¡çœ åšå‡†å¤‡ã€‚"
   
   AI (æ—  inquiry ä¸Šä¸‹æ–‡):
   "å¯ä»¥å°è¯• 30 åˆ†é’Ÿçš„ Zone 2 æœ‰æ°§è¿åŠ¨..."
   ```

5. **å†…å®¹æ¨èå½±å“** (`/api/curated-feed`):
   ```
   æ¨èå†…å®¹ä¼˜å…ˆçº§è°ƒæ•´:
   âœ… "Sleep Optimization: Circadian Rhythm Reset" (ä¼˜å…ˆ)
   âœ… "Why Sleep Matters for Recovery" (ä¼˜å…ˆ)
   â¬‡ï¸ "High-Intensity Training Guide" (é™ä½)
   ```

## ğŸ“Š ç›‘æ§å’Œè°ƒè¯•

### æŸ¥çœ‹ Inquiry æ•°æ®

```sql
-- æŸ¥çœ‹ç”¨æˆ·çš„ inquiry å†å²
SELECT 
  question_text,
  user_response,
  data_gaps_addressed,
  responded_at
FROM inquiry_history
WHERE user_id = 'xxx'
ORDER BY created_at DESC
LIMIT 10;

-- æŸ¥çœ‹åŒæ­¥åˆ° daily_calibrations çš„æ•°æ®
SELECT 
  date,
  sleep_hours,
  stress_level,
  exercise_duration,
  mood_score
FROM daily_calibrations
WHERE user_id = 'xxx'
ORDER BY date DESC
LIMIT 7;
```

### æ—¥å¿—è¾“å‡º

ç³»ç»Ÿä¼šåœ¨å…³é”®ç‚¹è¾“å‡ºæ—¥å¿—ï¼š

```
âœ… Synced sleep_hours to daily_calibrations: { sleep_hours: 5 }
ğŸ“‹ Inquiry ä¸Šä¸‹æ–‡å·²åŠ è½½: ç”¨æˆ·æœ€è¿‘çš„çŠ¶æ€ï¼š...
ğŸ“‹ Inquiry: æ£€æµ‹åˆ°ç¡çœ ä¸è¶³ï¼Œä¼˜å…ˆæ¨èç¡çœ ç›¸å…³å†…å®¹
ğŸ“‹ Inquiry å»ºè®®ä¸»é¢˜: sleep_optimization, circadian_rhythm
```

## ğŸ”® æœªæ¥æ‰©å±•

### 1. æ›´æ™ºèƒ½çš„é—®é¢˜ç”Ÿæˆ

æ ¹æ® inquiry å†å²è°ƒæ•´é—®é¢˜é¢‘ç‡å’Œç±»å‹ï¼š

```typescript
// å¦‚æœç”¨æˆ·æ€»æ˜¯å›ç­”"ç¡çœ å……è¶³"ï¼Œé™ä½ç¡çœ é—®é¢˜çš„è¯¢é—®é¢‘ç‡
// å¦‚æœç”¨æˆ·å‹åŠ›æŒç»­é«˜ï¼Œå¢åŠ å‹åŠ›ç›¸å…³çš„æ·±åº¦é—®é¢˜
```

### 2. è¶‹åŠ¿åˆ†æ

```typescript
// æ£€æµ‹ç”¨æˆ·çŠ¶æ€çš„å˜åŒ–è¶‹åŠ¿
if (last7DaysStress.average > previous7DaysStress.average + 2) {
  // è§¦å‘å…³æ€€æé†’
  // æ¨èå‹åŠ›ç®¡ç†è¯¾ç¨‹
}
```

### 3. ä¸ªæ€§åŒ– Feed æ¨è

```typescript
// æ ¹æ®ç”¨æˆ·çš„ inquiry å“åº”æ¨¡å¼ï¼Œè°ƒæ•´å†…å®¹ç±»å‹
if (user.prefersVideoContent && recentStressLevel === 'high') {
  // ä¼˜å…ˆæ¨èå†¥æƒ³è§†é¢‘è€Œä¸æ˜¯æ–‡ç« 
}
```

## ğŸ› ï¸ ç»´æŠ¤æŒ‡å—

### æ·»åŠ æ–°çš„ Inquiry ç±»å‹

1. åœ¨ `lib/inquiry-engine.ts` ä¸­æ·»åŠ æ–°çš„æ¨¡æ¿
2. åœ¨ `app/api/inquiry/respond/route.ts` ä¸­æ·»åŠ æ˜ å°„é€»è¾‘
3. åœ¨ `lib/inquiry-context.ts` ä¸­æ·»åŠ æ´å¯Ÿæå–é€»è¾‘
4. åœ¨ `app/api/curated-feed/route.ts` ä¸­æ·»åŠ æ¨èè°ƒæ•´é€»è¾‘

### è°ƒæ•´æ˜ å°„å€¼

ä¿®æ”¹ `app/api/inquiry/respond/route.ts` ä¸­çš„æ˜ å°„è¡¨ï¼š

```typescript
const sleepMap: Record<string, number> = {
  'under_6': 5,    // å¯ä»¥è°ƒæ•´ä¸º 5.5
  '6_7': 6.5,
  '7_8': 7.5,
  'over_8': 8.5,
};
```

## ğŸ“ æ€»ç»“

Active Inquiry System ç°åœ¨æ˜¯ä¸€ä¸ªå®Œæ•´çš„é—­ç¯ç³»ç»Ÿï¼š

1. âœ… **æ”¶é›†æ•°æ®**: é€šè¿‡ Banner ä¸»åŠ¨è¯¢é—®
2. âœ… **å­˜å‚¨æ•°æ®**: åŒæ­¥åˆ° daily_calibrations
3. âœ… **æå–æ´å¯Ÿ**: åˆ†æç”¨æˆ·çŠ¶æ€å’Œè¶‹åŠ¿
4. âœ… **å½±å“ AI**: è°ƒæ•´å¯¹è¯ç­–ç•¥å’Œå»ºè®®
5. âœ… **ä¼˜åŒ–æ¨è**: ä¸ªæ€§åŒ–å†…å®¹æ¨è

ç”¨æˆ·çš„æ¯ä¸€æ¬¡å›ç­”éƒ½ä¼šè®©æ•´ä¸ªç³»ç»Ÿæ›´äº†è§£ä»–ä»¬ï¼Œæä¾›æ›´ç²¾å‡†çš„å¥åº·å»ºè®®ï¼
