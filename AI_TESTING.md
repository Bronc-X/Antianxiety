# AI 功能测试指南

## 测试前准备

1. **确保环境变量已配置**
   ```bash
   npm run check-env
   ```

2. **启动开发服务器**
   ```bash
   npm run dev
   ```

## 测试步骤

### 1. 访问 AI 助理页面

打开浏览器访问：`http://localhost:3000/assistant`

### 2. 测试基本对话功能

1. **发送测试消息**
   - 在输入框中输入："你好，我想了解如何缓解焦虑"
   - 点击"发送"按钮
   - 等待 AI 回复

2. **预期结果**
   - ✅ AI 应该在几秒内回复
   - ✅ 回复内容应该与健康/焦虑相关
   - ✅ 回复应该使用中文
   - ✅ 回复应该基于生理科学，而非鼓励性语言

### 3. 测试对话历史

1. **继续对话**
   - 发送第二条消息："我应该如何开始？"
   - 检查 AI 是否理解上下文

2. **预期结果**
   - ✅ AI 应该记住之前的对话
   - ✅ 回复应该与之前的对话相关

### 4. 测试错误处理

1. **测试未授权访问**
   - 如果未登录，尝试访问 `/api/ai/chat`
   - 应该返回 401 错误

2. **测试 API Key 缺失**
   - 如果 `DEEPSEEK_API_KEY` 未设置，应该显示友好错误消息

### 5. 检查浏览器控制台

打开浏览器开发者工具（F12），检查：

- **网络请求**
  - `/api/ai/chat` 请求应该返回 200 状态码
  - 响应应该包含 `response` 和 `usage` 字段

- **控制台错误**
  - 不应该有红色错误信息
  - 如果有错误，记录错误信息

## 常见问题排查

### 问题 1: AI 回复显示"AI 服务未配置"

**原因**: `DEEPSEEK_API_KEY` 环境变量未设置或无效

**解决**:
1. 检查 `.env.local` 文件是否存在
2. 确认 `DEEPSEEK_API_KEY` 已正确设置
3. 重启开发服务器（环境变量只在启动时加载）

### 问题 2: AI 回复显示"未授权"

**原因**: 用户未登录或认证失败

**解决**:
1. 确保已登录
2. 检查 Supabase 配置是否正确
3. 检查浏览器 Cookie 是否正常

### 问题 3: AI 回复很慢或超时

**原因**: 
- DeepSeek API 响应慢
- 网络连接问题
- API 配额限制

**解决**:
1. 检查网络连接
2. 登录 DeepSeek 控制台查看 API 使用情况
3. 检查是否有速率限制

### 问题 4: AI 回复内容不符合预期

**原因**: 
- 系统提示词可能需要调整
- API 模型参数可能需要优化

**解决**:
1. 检查 `app/api/ai/chat/route.ts` 中的 `buildSystemPrompt` 函数
2. 调整 `temperature` 参数（当前为 0.7）
3. 检查用户资料是否正确传递

## 生产环境测试

部署到 Cloudflare Pages 后，需要：

1. **验证环境变量**
   - 在 Cloudflare Dashboard 中确认所有环境变量已设置
   - 特别是 `DEEPSEEK_API_KEY` 和 Supabase 相关变量

2. **测试生产环境**
   - 访问部署后的网站
   - 登录账户
   - 测试 AI 聊天功能

3. **监控 API 使用**
   - 定期检查 DeepSeek API 使用量
   - 设置使用量告警（如果支持）

## 性能优化建议

1. **流式输出**（未来优化）
   - 当前使用非流式输出
   - 可以考虑实现流式响应，提升用户体验

2. **缓存机制**（未来优化）
   - 缓存常见问题的回复
   - 减少 API 调用次数

3. **错误重试**（未来优化）
   - 添加自动重试机制
   - 处理临时网络错误

## 相关文档

- `DEEPSEEK_SETUP.md` - DeepSeek API 配置指南
- `ENV_SETUP.md` - 环境变量配置指南
- `cloudflare-deployment.md` - Cloudflare 部署指南

