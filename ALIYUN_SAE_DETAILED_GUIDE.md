# 阿里云 SAE 详细部署指南

## 📋 目录

1. [开通 Serverless 应用引擎（SAE）](#1-开通-serverless-应用引擎sae)
2. [准备 Docker 镜像](#2-准备-docker-镜像)
3. [在 SAE 中创建应用](#3-在-sae-中创建应用)
4. [配置环境变量](#4-配置环境变量)
5. [部署和测试](#5-部署和测试)
6. [常见问题](#常见问题)

---

## 1. 开通 Serverless 应用引擎（SAE）

### 步骤 1.1: 登录阿里云控制台

1. 访问 https://ecs.console.aliyun.com 或 https://console.aliyun.com
2. 使用你的阿里云账号登录

### 步骤 1.2: 搜索并进入 SAE

1. 在控制台顶部搜索框输入：**Serverless 应用引擎** 或 **SAE**
2. 点击搜索结果中的 **Serverless 应用引擎**

### 步骤 1.3: 开通服务

1. 如果是首次使用，会看到 **立即开通** 或 **免费试用** 按钮
2. 点击开通服务
3. 阅读并同意服务协议
4. 等待开通完成（通常几秒钟）

### 步骤 1.4: 创建命名空间（可选但推荐）

1. 在 SAE 控制台左侧菜单，点击 **命名空间**
2. 点击 **创建命名空间**
3. 填写信息：
   - **命名空间名称**: `nomoreanxious` 或 `default`
   - **命名空间 ID**: 自动生成或自定义
   - **描述**: 可选
4. 点击 **确定**

**注意**：如果没有创建命名空间，系统会使用默认命名空间。

---

## 2. 准备 Docker 镜像

### 步骤 2.1: 获取 ACR 登录信息

1. 在阿里云控制台，搜索 **容器镜像服务** 或 **ACR**
2. 进入容器镜像服务控制台
3. 点击左侧菜单 **访问凭证**
4. 设置或查看 **登录密码**（如果还没有设置，点击 **设置密码**）
5. 记录以下信息：
   - **登录地址**：例如 `registry.cn-hangzhou.aliyuncs.com`
   - **用户名**：通常是你的阿里云账号
   - **密码**：你设置的密码

### 步骤 2.2: 创建镜像仓库

1. 在 ACR 控制台，点击左侧菜单 **镜像仓库**
2. 点击 **创建镜像仓库**
3. 填写信息：
   - **命名空间**: 选择或创建（如：`nomoreanxious`）
   - **仓库名称**: `nomoreanxious` 或 `anxious`
   - **仓库类型**: 选择 **私有**
   - **摘要**: 可选，如 "Next.js 应用"
   - **代码源**: 选择 **不绑定**（我们手动推送）
4. 点击 **下一步** → **创建镜像仓库**
5. 记录完整的镜像地址，格式：`registry.cn-hangzhou.aliyuncs.com/命名空间/仓库名称`

### 步骤 2.3: 本地登录 ACR

打开 PowerShell 或终端，执行：

```powershell
# 替换为你的登录地址
docker login registry.cn-hangzhou.aliyuncs.com

# 输入用户名和密码
# Username: 你的阿里云账号
# Password: 你设置的密码
```

**成功提示**：`Login Succeeded`

### 步骤 2.4: 修改构建脚本

编辑 `docker-build.ps1` 文件，修改以下变量：

```powershell
$REGISTRY = "registry.cn-hangzhou.aliyuncs.com"  # 你的登录地址
$NAMESPACE = "nomoreanxious"  # 你的命名空间（在 ACR 中创建的）
$IMAGE_NAME = "nomoreanxious"  # 你的仓库名称
$VERSION = "latest"  # 版本标签
```

**示例**：
- 如果你的登录地址是 `registry.cn-beijing.aliyuncs.com`
- 命名空间是 `myapp`
- 仓库名称是 `anxious`

则修改为：
```powershell
$REGISTRY = "registry.cn-beijing.aliyuncs.com"
$NAMESPACE = "myapp"
$IMAGE_NAME = "anxious"
```

### 步骤 2.5: 构建和推送镜像

在项目根目录执行：

```powershell
# 运行构建脚本
.\docker-build.ps1
```

**构建过程**：
1. 构建 Docker 镜像（可能需要几分钟）
2. 标记镜像
3. 推送到 ACR

**成功标志**：
- 看到 `✅ 构建成功！`
- 看到 `✅ 推送成功！`
- 看到镜像地址，如：`registry.cn-hangzhou.aliyuncs.com/nomoreanxious/nomoreanxious:latest`

### 步骤 2.6: 验证镜像

1. 在 ACR 控制台，进入 **镜像仓库**
2. 找到你创建的仓库
3. 点击仓库名称，查看镜像版本
4. 应该能看到 `latest` 标签的镜像

---

## 3. 在 SAE 中创建应用

### 步骤 3.1: 进入 SAE 控制台

1. 在阿里云控制台，搜索 **Serverless 应用引擎** 或 **SAE**
2. 进入 SAE 控制台

### 步骤 3.2: 创建应用

1. 点击 **应用管理** → **应用列表**
2. 点击 **创建应用** 按钮（通常在右上角）

### 步骤 3.3: 选择部署方式

选择 **镜像部署**（不是 JAR 包部署）

### 步骤 3.4: 填写基本信息

#### 3.4.1 应用信息

- **应用名称**: `nomoreanxious` 或 `anxious`
- **命名空间**: 选择你在步骤 1.4 创建的命名空间，或使用默认
- **应用描述**: 可选，如 "Next.js 应用"

#### 3.4.2 应用配置

- **应用类型**: 选择 **Web 应用**
- **技术栈语言**: 选择 **Java**（虽然我们是 Node.js，但 SAE 会通过镜像自动识别）
- **应用部署方式**: **镜像**

### 步骤 3.5: 配置镜像

#### 3.5.1 镜像配置

- **镜像地址**: 
  - 点击 **选择镜像**
  - 选择你的 ACR 镜像仓库
  - 或直接输入完整地址：`registry.cn-hangzhou.aliyuncs.com/nomoreanxious/nomoreanxious:latest`
- **镜像拉取策略**: 选择 **总是拉取最新镜像**（确保每次部署都使用最新版本）
- **镜像版本**: `latest` 或具体版本号

#### 3.5.2 实例配置

- **实例规格**:
  - **CPU**: `0.5 核`（最小规格，节省成本）
  - **内存**: `1 GB`（最小规格）
- **实例数量**: `1`（单实例即可，后续可扩容）
- **VPC 配置**: 
  - 选择 **使用已有VPC** 或 **自动创建VPC**
  - 如果没有 VPC，选择自动创建

### 步骤 3.6: 配置端口和协议

- **端口**: `3000`（Next.js 默认端口）
- **协议**: `HTTP`
- **容器端口**: `3000`

### 步骤 3.7: 配置访问设置

#### 3.7.1 公网访问

- **是否开启公网访问**: 选择 **是**
- **SLB 实例**: 
  - 如果已有 SLB 实例，选择现有实例
  - 如果没有，选择 **自动创建**（SAE 会自动创建并配置）

#### 3.7.2 访问路径（可选）

- **路径**: `/`（默认，所有路径）
- **健康检查路径**: `/` 或 `/api/health`（如果有健康检查接口）

### 步骤 3.8: 配置环境变量

**重要**：这是关键步骤！

点击 **环境变量设置**，添加以下变量：

| 变量名 | 变量值 | 说明 |
|--------|--------|------|
| `DEEPSEEK_API_KEY` | `sk-df1dcd335c3f43ef94621d654e645088` | DeepSeek API 密钥 |
| `NEXT_PUBLIC_SUPABASE_URL` | `https://hxthvavzdtybkryojudt.supabase.co` | Supabase URL |
| `NEXT_PUBLIC_SUPABASE_ANON_KEY` | `sb_publishable_ZKHE_7pEfxhwDS1UEMAD2g_hYeWrR1c` | Supabase 匿名密钥 |
| `NODE_ENV` | `production` | 生产环境标识 |
| `PORT` | `3000` | 应用端口（可选，Dockerfile 已设置） |

**添加方法**：
1. 点击 **添加环境变量**
2. 输入变量名和变量值
3. 点击 **确定**
4. 重复添加所有变量

### 步骤 3.9: 高级配置（可选）

#### 3.9.1 日志配置

- **日志收集**: 建议开启
- **日志路径**: `/app/logs`（可选）

#### 3.9.2 监控配置

- **应用监控**: 建议开启（免费）
- **链路追踪**: 可选

#### 3.9.3 其他配置

- **启动命令**: 留空（Dockerfile 中已配置）
- **停止前处理时间**: `30` 秒（默认）

### 步骤 3.10: 确认并创建

1. 检查所有配置是否正确
2. 点击 **确认** 或 **创建**
3. 等待应用创建完成（通常需要 1-3 分钟）

---

## 4. 配置环境变量（如果创建时未配置）

如果创建应用时忘记配置环境变量，可以后续添加：

### 步骤 4.1: 进入应用详情

1. 在 SAE 控制台，进入 **应用管理** → **应用列表**
2. 找到你的应用，点击应用名称

### 步骤 4.2: 修改配置

1. 点击 **变更配置** 或 **配置管理**
2. 找到 **环境变量** 部分
3. 添加或修改环境变量
4. 点击 **保存**

### 步骤 4.3: 重新部署

修改配置后，需要重新部署应用：

1. 在应用详情页，点击 **部署** 或 **重新部署**
2. 选择部署版本（选择最新镜像）
3. 点击 **确认部署**
4. 等待部署完成

---

## 5. 部署和测试

### 步骤 5.1: 查看部署状态

1. 在应用详情页，查看 **部署记录**
2. 等待状态变为 **运行中**（绿色）

### 步骤 5.2: 获取访问地址

1. 在应用详情页，找到 **访问设置** 或 **公网访问地址**
2. 复制访问地址，格式类似：`http://xxx-xxx.cn-hangzhou.alicontainer.com`

### 步骤 5.3: 测试访问

1. 在浏览器中打开访问地址
2. 应该能看到你的 Next.js 应用首页
3. 测试主要功能：
   - 注册/登录
   - AI 聊天功能
   - 数据展示

### 步骤 5.4: 查看日志（如果遇到问题）

1. 在应用详情页，点击 **日志管理** 或 **实时日志**
2. 查看应用启动日志和运行日志
3. 检查是否有错误信息

---

## 常见问题

### Q1: 应用启动失败？

**检查项**：
1. 环境变量是否正确配置
2. 镜像地址是否正确
3. 端口配置是否正确（应该是 3000）
4. 查看日志中的错误信息

**解决方法**：
- 检查 Dockerfile 中的 `EXPOSE 3000` 和 `ENV PORT=3000`
- 确认环境变量都已添加
- 查看应用日志定位问题

### Q2: 无法访问应用？

**检查项**：
1. 是否开启了公网访问
2. SLB 实例是否正常
3. 应用是否处于运行状态

**解决方法**：
- 在应用详情页，检查 **访问设置**
- 确认公网访问已开启
- 检查应用状态是否为 **运行中**

### Q3: 镜像拉取失败？

**检查项**：
1. 镜像地址是否正确
2. ACR 权限是否正确
3. 网络连接是否正常

**解决方法**：
- 确认镜像已成功推送到 ACR
- 检查 ACR 镜像仓库的访问权限
- 在 SAE 中重新选择镜像

### Q4: 环境变量不生效？

**检查项**：
1. 环境变量名称是否正确（注意大小写）
2. 是否重新部署了应用
3. 变量值是否正确

**解决方法**：
- 修改环境变量后，必须重新部署应用
- 检查环境变量名称是否与代码中使用的完全一致
- 查看日志确认环境变量是否被正确读取

### Q5: 如何更新应用？

**步骤**：
1. 修改代码
2. 重新构建和推送镜像：
   ```powershell
   .\docker-build.ps1
   ```
3. 在 SAE 应用详情页，点击 **部署**
4. 选择最新镜像版本
5. 点击 **确认部署**

### Q6: 如何查看应用监控？

1. 在应用详情页，点击 **监控** 或 **应用监控**
2. 可以查看：
   - CPU 使用率
   - 内存使用率
   - 请求量
   - 错误率

### Q7: 如何配置自定义域名？

1. 在应用详情页，进入 **访问设置**
2. 配置 **自定义域名**
3. 需要先购买域名并完成备案（国内）
4. 配置 DNS 解析

---

## 📝 检查清单

部署前检查：

- [ ] SAE 服务已开通
- [ ] ACR 服务已开通
- [ ] 镜像仓库已创建
- [ ] Docker 镜像已构建并推送
- [ ] 环境变量已配置（4个变量）
- [ ] 应用已创建并部署
- [ ] 应用状态为 **运行中**
- [ ] 可以正常访问应用

---

## 🎉 完成！

如果所有步骤都完成，你的应用应该已经成功部署到阿里云 SAE 了！

如果遇到任何问题，请查看日志或联系我。

