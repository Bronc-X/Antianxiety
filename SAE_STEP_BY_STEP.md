# SAE 部署 - 分步操作指南

## ✅ 已完成
- [x] 开通容器镜像服务（ACR）

## 📋 待完成步骤

### 步骤 1: 开通 Serverless 应用引擎（SAE）

#### 1.1 登录阿里云控制台
- 访问：https://console.aliyun.com
- 使用你的阿里云账号登录

#### 1.2 搜索 SAE
- 在控制台顶部搜索框输入：**Serverless 应用引擎** 或 **SAE**
- 点击搜索结果进入

#### 1.3 开通服务
- 如果是首次使用，点击 **立即开通** 或 **免费试用**
- 阅读并同意服务协议
- 等待开通完成（几秒钟）

#### 1.4 创建命名空间（推荐）
- 在左侧菜单点击 **命名空间**
- 点击 **创建命名空间**
- 填写：
  - 命名空间名称：`nomoreanxious`（或自定义）
  - 其他保持默认
- 点击 **确定**

---

### 步骤 2: 准备 Docker 镜像（ACR 部分）

#### 2.1 获取 ACR 登录信息
1. 在控制台搜索 **容器镜像服务** 或 **ACR**
2. 进入 ACR 控制台
3. 点击左侧 **访问凭证**
4. 设置或查看登录密码
5. 记录：
   - **登录地址**：例如 `registry.cn-hangzhou.aliyuncs.com`
   - **用户名**：你的阿里云账号
   - **密码**：你设置的密码

#### 2.2 创建镜像仓库
1. 在 ACR 控制台，点击 **镜像仓库**
2. 点击 **创建镜像仓库**
3. 填写：
   - **命名空间**：选择或创建（如：`nomoreanxious`）
   - **仓库名称**：`nomoreanxious` 或 `anxious`
   - **仓库类型**：**私有**
   - **代码源**：**不绑定**
4. 点击 **创建镜像仓库**
5. **记录完整镜像地址**，格式：
   ```
   registry.cn-hangzhou.aliyuncs.com/命名空间/仓库名称
   ```

#### 2.3 修改构建脚本
编辑 `docker-build.ps1`，修改以下变量：

```powershell
$REGISTRY = "registry.cn-hangzhou.aliyuncs.com"  # 你的登录地址
$NAMESPACE = "nomoreanxious"  # 你的命名空间
$IMAGE_NAME = "nomoreanxious"  # 你的仓库名称
```

**示例**：
- 如果你的登录地址是 `registry.cn-beijing.aliyuncs.com`
- 命名空间是 `myapp`
- 仓库名称是 `anxious`

则修改为：
```powershell
$REGISTRY = "registry.cn-beijing.aliyuncs.com"
$NAMESPACE = "myapp"
$IMAGE_NAME = "anxious"
```

#### 2.4 登录 ACR
打开 PowerShell，执行：

```powershell
docker login registry.cn-hangzhou.aliyuncs.com
```

输入用户名和密码。

**成功提示**：`Login Succeeded`

#### 2.5 构建和推送镜像
在项目根目录执行：

```powershell
.\docker-build.ps1
```

**等待构建完成**（可能需要几分钟）

**成功标志**：
- ✅ 构建成功！
- ✅ 推送成功！
- 显示镜像地址

#### 2.6 验证镜像
1. 在 ACR 控制台，进入 **镜像仓库**
2. 找到你的仓库，点击进入
3. 应该能看到 `latest` 标签的镜像

---

### 步骤 3: 在 SAE 中创建应用

#### 3.1 进入 SAE 控制台
- 搜索 **Serverless 应用引擎** 或 **SAE**
- 进入控制台

#### 3.2 创建应用
- 点击 **应用管理** → **应用列表**
- 点击 **创建应用** 按钮

#### 3.3 选择部署方式
- 选择 **镜像部署**（不是 JAR 包）

#### 3.4 填写基本信息

**应用信息**：
- 应用名称：`nomoreanxious`
- 命名空间：选择你创建的命名空间
- 应用描述：可选

**应用配置**：
- 应用类型：**Web 应用**
- 技术栈语言：**Java**（SAE 会自动识别 Node.js）
- 应用部署方式：**镜像**

#### 3.5 配置镜像

**镜像配置**：
- 点击 **选择镜像**
- 选择你的 ACR 镜像仓库
- 或直接输入完整地址：
  ```
  registry.cn-hangzhou.aliyuncs.com/nomoreanxious/nomoreanxious:latest
  ```
- 镜像拉取策略：**总是拉取最新镜像**

**实例配置**：
- CPU：**0.5 核**（最小规格）
- 内存：**1 GB**（最小规格）
- 实例数量：**1**

**VPC 配置**：
- 选择 **自动创建VPC**（如果没有 VPC）

#### 3.6 配置端口
- 端口：**3000**
- 协议：**HTTP**
- 容器端口：**3000**

#### 3.7 配置访问设置
- 是否开启公网访问：**是**
- SLB 实例：**自动创建**

#### 3.8 配置环境变量 ⚠️ 重要！

点击 **环境变量设置**，添加以下 4 个变量：

| 变量名 | 变量值 |
|--------|--------|
| `DEEPSEEK_API_KEY` | `sk-df1dcd335c3f43ef94621d654e645088` |
| `NEXT_PUBLIC_SUPABASE_URL` | `https://hxthvavzdtybkryojudt.supabase.co` |
| `NEXT_PUBLIC_SUPABASE_ANON_KEY` | `sb_publishable_ZKHE_7pEfxhwDS1UEMAD2g_hYeWrR1c` |
| `NODE_ENV` | `production` |

**添加方法**：
1. 点击 **添加环境变量**
2. 输入变量名和变量值
3. 点击 **确定**
4. 重复添加所有 4 个变量

#### 3.9 高级配置（可选）
- 日志收集：建议开启
- 应用监控：建议开启（免费）

#### 3.10 创建应用
1. 检查所有配置
2. 点击 **确认** 或 **创建**
3. **等待部署完成**（1-3 分钟）

---

### 步骤 4: 测试部署

#### 4.1 查看部署状态
- 在应用详情页，查看 **部署记录**
- 等待状态变为 **运行中**（绿色）

#### 4.2 获取访问地址
- 在应用详情页，找到 **访问设置** 或 **公网访问地址**
- 复制访问地址

#### 4.3 测试访问
- 在浏览器打开访问地址
- 应该能看到你的应用首页
- 测试主要功能

#### 4.4 查看日志（如有问题）
- 在应用详情页，点击 **日志管理** 或 **实时日志**
- 查看错误信息

---

## 🎯 快速检查清单

- [ ] SAE 服务已开通
- [ ] 命名空间已创建
- [ ] ACR 镜像仓库已创建
- [ ] Docker 已登录 ACR
- [ ] 镜像已构建并推送
- [ ] SAE 应用已创建
- [ ] 环境变量已配置（4个）
- [ ] 应用状态为 **运行中**
- [ ] 可以正常访问应用

---

## 🆘 遇到问题？

### 应用启动失败？
1. 检查环境变量是否正确
2. 查看应用日志
3. 确认镜像地址正确

### 无法访问？
1. 检查是否开启公网访问
2. 确认应用状态为 **运行中**
3. 检查 SLB 配置

### 镜像拉取失败？
1. 确认镜像已推送
2. 检查 ACR 权限
3. 重新选择镜像

---

## 📚 详细文档

如需更详细的说明，请查看：
- `ALIYUN_SAE_DETAILED_GUIDE.md` - 完整详细指南
- `ALIYUN_QUICK_START.md` - 快速开始指南

---

## ✅ 完成！

如果所有步骤都完成，你的应用应该已经成功部署了！

如有问题，请查看日志或告诉我。

