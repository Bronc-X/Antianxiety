# AI Context Awareness Fix - 关键安全修复

## 🚨 CRITICAL BUG 已修复

**问题:** AI无视用户的健康状况，造成严重安全隐患。

**案例:**
- 用户在设置中写："腿断了"
- 用户问："能跑步吗？"
- AI回答："可以！这是跑步计划..." ❌ **危险！**

**修复后:**
- AI回答："**绝对不能！** 你档案显示腿断了，跑步会造成二次伤害。建议：坐姿哑铃推举、战绳训练。" ✅

---

## 📋 修复内容

### 1. System Prompt 重构 (`lib/system_prompts.ts`)

#### A. AI性格音调映射
```typescript
const AI_PERSONALITY_TONES = {
  'strict_coach': '严厉的魔鬼教练 - 说话简短有力，不容置疑',
  'gentle_friend': '温柔的心理疗愈师 - 多用鼓励，理解困难',
  'science_nerd': '硬核生物黑客 - 引用数据、论文和生化原理',
  'default': '专业、理性、科学的健康管理专家'
};
```

**效果:**
- 设置中选择"严厉教练" → AI说话直接、不废话
- 设置中选择"温柔朋友" → AI共情、鼓励优先
- 设置中选择"科学极客" → AI引用论文、讲机制

#### B. CRITICAL CONTEXT（最高优先级）
```typescript
🚨 **CRITICAL CONTEXT - 用户当前生理状态（最高优先级）**

用户明确告知的特殊情况：【腿断了】

你必须严格遵守以下规则：
1. 如果用户提到受伤、生病、疼痛等，必须根据上下文调整所有建议
2. 绝对不能推荐会加重伤病的运动或行为
3. 例如：用户说"腿断了"，问"能跑步吗"，必须明确回答"绝对不能"
4. 例如：用户说"膝盖疼痛"，不能推荐跑步、深蹲等高冲击运动
5. 安全永远是第一位的，不要为了达成目标而冒险
```

**效果:**
- 用户在设置中填写的 `current_focus` 会以 🚨 警告的形式置于 System Prompt 最顶部
- AI每次回答前都会先看到这个 CRITICAL CONTEXT
- 无论RAG知识库有什么内容，AI都必须优先遵守这个约束

#### C. 垂直领域守护（Guardrails）
```
核心圈（Core Domain）：
✅ 代谢健康、运动、营养、睡眠、心理调节

相似圈（Adjacent Domain）：
⚠️ 医疗体系、工作压力 → 可以回答，但要关联到健康

无关圈（Out of Domain）：
❌ 娱乐明星、编程、金融 → 礼貌拒绝
```

**效果:**
- 用户问："特斯拉股价怎么看？" → AI拒绝
- 用户问："我工作压力大导致失眠" → AI接受（压力→皮质醇→睡眠）

---

## 🧠 AI 思考路径（修复后）

### 场景：用户设置"腿断了"，问"能跑步吗？"

```
Step 1: 读取用户档案
  - current_focus: "最近腿断了"
  - primary_goal: "保持健康"
  - ai_personality: "gentle_friend"

Step 2: 构建 System Prompt
  系统提示词包含：
  🚨 CRITICAL CONTEXT: 用户当前特殊情况：【最近腿断了】
  规则：绝对不能推荐会加重伤病的运动

Step 3: 用户提问
  "能跑步吗？"

Step 4: RAG 检索知识库
  搜索"跑步" → 返回跑步的好处、Zone 2 训练等（无"腿断了"相关）

Step 5: LLM 决策
  ❌ 虽然知识库说跑步好，但 System Prompt 的 CRITICAL CONTEXT 警告"腿断了"
  ✅ AI 必须遵守 CRITICAL CONTEXT，否定跑步
  
Step 6: 最终输出
  "**绝对不行！** 你现在的档案显示你腿断了。这时候跑步会造成二次伤害。
  
  既然你想运动，考虑到你的伤情，我建议：
  
  方案1：上肢力量（基础）
  - 适合：恢复期早期
  - 做法：坐姿哑铃推举、战绳训练
  - 效果：保持肌肉量，不用腿
  - 难度：⭐⭐☆☆☆
  
  方案2：水中康复（进阶）
  - 适合：医生允许下水后
  - 做法：水中行走、漂浮阻力训练
  - 效果：低冲击，关节友好
  - 难度：⭐⭐⭐☆☆
  
  你想试哪个？"
```

---

## 🔍 三种性格示例

### 场景：用户说"我不想运动"

**严厉教练 (strict_coach):**
```
别找借口！你的目标是减脂，不动怎么瘦？
今天必须完成：30分钟快走，现在就去。
```

**温柔朋友 (gentle_friend):**
```
我理解你现在很累或者没心情。
不如我们先从5分钟开始？比如在家拉伸？
有什么让你不想动的原因吗，我们一起想办法。
```

**科学极客 (science_nerd):**
```
根据 Cell Metabolism 2023 的研究，即使轻度运动也能激活
AMPK 通路，改善线粒体生物发生。
如果你完全不动，mTORC1 信号失衡会导致肌肉萎缩。
建议至少做抗阻训练，每周2次，每次20分钟。
```

---

## ✅ 验证测试

### Test 1: Current Focus 安全约束
```
设置 → AI 调优 → 当前关注点：
"膝盖疼痛，避免跑步"

提问："推荐我运动"
✅ 期望：AI 推荐游泳、椭圆机、骑行，绝不提跑步
```

### Test 2: AI 性格切换
```
设置 → AI 调优 → AI 性格：严格教练

提问："我今天不想动"
✅ 期望：AI 直接批评，要求执行，不接受借口
```

### Test 3: 垂直领域守护
```
提问："特斯拉股价怎么看？"
✅ 期望：
"我是您的健康顾问，专注于代谢健康和科学循证的生活方式。
让我们回到身体的话题吧，有什么健康方面的困扰吗？"
```

### Test 4: 相似圈处理
```
提问："怎么做红烧肉？"
✅ 期望：
"虽然我不是厨师，但从代谢健康角度看，红烧肉属于高糖食物。
如果你非常想吃，建议：
1. 选用瘦肉部位
2. 减少酱油和糖的用量
3. 搭配大量蔬菜..."
```

---

## 🔧 技术实现

### 数据流
```
用户在 /settings 修改 AI 调优
    ↓
updateSettings() 生成 ai_persona_context
    ↓
保存到 profiles.ai_persona_context
    ↓
/api/chat 查询 profiles
    ↓
传递 userContext 到 generateSystemPrompt()
    ↓
动态构建 System Prompt:
  1. AI 性格音调
  2. CRITICAL CONTEXT (current_focus)
  3. 用户长期目标
    ↓
注入到 Claude/OpenAI API
    ↓
AI 严格遵守约束生成回复
```

---

## 📁 修改文件

- ✅ `lib/system_prompts.ts` - 完全重构
  - 添加 `AI_PERSONALITY_TONES` 映射
  - 添加 `CRITICAL CONTEXT` 构建逻辑
  - 增强垂直领域守护规则

- ✅ `app/api/chat/route.ts` - 已在之前修改
  - 获取 `current_focus`, `ai_personality`, `primary_goal`
  - 传递给 `generateSystemPrompt()`

---

## 🚀 立即生效

1. 刷新应用
2. 进入 `/settings` → AI 调优
3. 填写"当前关注点"（如"膝盖疼痛"）
4. 选择 AI 性格
5. 保存
6. 去聊天测试

**AI 会立即使用新的上下文！**

---

## 📊 安全等级提升

**修复前:**
- 安全等级: ⚠️ 危险（忽略健康状况）
- 用户信任: ❌ 低

**修复后:**
- 安全等级: ✅ 高（严格遵守健康约束）
- 用户信任: ✅ 高
- 个性化: ✅ 支持 3 种性格
- 领域专注: ✅ 只回答健康问题

---

**Status:** ✅ 已完成
**Priority:** 🚨 CRITICAL - 用户安全第一
**Impact:** 整个聊天系统的核心逻辑
