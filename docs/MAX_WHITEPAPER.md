# MAX 白皮书

## 摘要
MAX 是面向焦虑、压力与睡眠场景的个人健康智能体。本白皮书说明 MAX 的提示词结构、上下文管线、确定性策略与安全边界，并记录基于 Manus 的 Context Engineering 经验所做的关键改造。

## 设计目标
- 高可信：只使用系统给定事实，避免幻觉与过度推断。
- 高一致：中文界面输出中文，语气稳定，结构可控。
- 高效率：稳定前缀、上下文尾部追加，提升缓存命中与吞吐。
- 高适配：按用户状态和对话轮次动态调整。

## 系统架构概览
1. 数据输入
   - 用户档案：目标、偏好、AI 设置、代谢关注点等
   - 今日与近 7 天日志：睡眠、压力、运动等
   - 每日问卷：当前主观状态
   - 活跃方案：执行项与完成状态
   - 记忆检索：与当前问题相关的历史片段
2. 上下文优化
   - 会话状态提取（重复健康上下文、已引用论文等）
   - 上下文注入优化（首轮完整、后续提醒）
   - 回复变化策略（结构轮换、称呼控制）
3. 生成与输出
   - 统一系统提示 + 动态上下文包
   - 科研搜索与引用
   - 统一模型优先级与回退策略

## 提示词结构（Context Envelope v2）
系统提示被拆分为“稳定前缀 + 动态上下文包”，以提高缓存命中率并减少无谓波动。

```
[SYSTEM_PROMPT_PREFIX]  // 固定规则、边界与策略

[CONTEXT ENVELOPE v2]
<CONTEXT>
[AI CONFIGURATION]
...

[AI PERSONA]
...

[USER CONTEXT]
...

[MEMORY CONTEXT]
...

[OPTIMIZED CONTEXT]
...

[RESPONSE VARIATION]
...

[FOCUS RECAP]
...
</CONTEXT>
```

说明：
- 任何块若为 `NO_DATA`，代表系统没有该信息，禁止猜测。
- `FOCUS RECAP` 放在末尾，用于“复诵”关键目标与限制，保证最高优先级注意力。

## Manus 借鉴要点与落地
1. 稳定前缀（KV Cache）
   - 固定“核心原则、边界规则、数据使用策略”不随请求波动。
2. 上下文尾部追加
   - 动态数据统一进入 `CONTEXT ENVELOPE`，避免在提示中间插入变化段落。
3. 确定性序列化
   - 问卷字段按固定顺序输出，避免对象遍历导致顺序漂移。
   - 活跃方案日期使用 ISO 格式，避免本地化差异。
4. 去随机
   - 变化策略中的称呼选择改为确定性算法，移除 prompt 内随机值注入。
5. 复诵（Recitation）
   - `FOCUS RECAP` 汇总“健康限制、主要目标、今日关键状态、对话摘要”。

## 关键策略
### 数据约束
- 只引用上下文出现的事实与论文。
- 缺失数据明确“当前未知”，并提出一个关键澄清问题。

### 话题边界
- 非健康领域话题禁止回答，需转回健康相关对话。

### 结构变化
- 首轮结构化输出，后续轮次轮换风格，避免模板化疲劳。

## 运行参数与版本治理
- 模型优先级由 `lib/ai/model-config.ts` 统一管理。
- 采样参数（temperature/top_p 等）当前未显式固定，默认使用模型提供方的默认值；如需更强可复现性，建议统一配置并写入版本日志。
- 上下文格式使用 `CONTEXT_ENVELOPE_VERSION` 标记；结构或字段有破坏性变化时必须升级版本号并记录变更点。

## 调试与回溯
- `/api/debug/ai-context` 会返回 `CONTEXT ENVELOPE` 与 `FOCUS RECAP`，用于排查上下文漂移与字段缺失。

## 观测与测试
建议最少验证：
- `context-optimizer` 与 `response-variation` 的单元与性质测试。
- Chat integration property tests。
- 端到端：首轮包含健康上下文，后续轮次不重复完整提示。

## 未来工作
- Tool-state 级别的细粒度状态机（mask 而非删）。
- 多语言一致性与“术语翻译层”进一步组件化。
- Memory 与计划执行状态的长期摘要化存储（减少上下文体积）。
